<!doctype html><html lang="en">
 <head>
  <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
  <title>Private Network Access</title>
  <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport">
  <link href="https://www.w3.org/StyleSheets/TR/2021/cg-draft" rel="stylesheet">
  <meta content="Bikeshed version 5fcd28d6d, updated Tue May 30 13:12:11 2023 -0700" name="generator">
  <link href="https://wicg.github.io/private-network-access/" rel="canonical">
  <meta content="6f2e27b7b0bd4d4442a92357feca16b51f88cb27" name="document-revision">
<style>
  ul.toc ul ul ul {
    margin: 0 0 0 2em;
  }
  ul.toc ul ul ul span.secno {
    margin-left: -9em;
  }
  table {
    border-collapse: collapse;
    width: 100%;
    caption-side: bottom;
  }
  table caption {
    padding: 5px;
  }
  th, td {
    border-width: 1px;
    border-style: solid;
    padding: 5px 10px;
  }
  th {
    background-color: lightblue;
    border-color: black;
  }
  td {
    border-color: grey;
  }
</style>
<style>/* Boilerplate: style-autolinks */
.css.css, .property.property, .descriptor.descriptor {
    color: var(--a-normal-text);
    font-size: inherit;
    font-family: inherit;
}
.css::before, .property::before, .descriptor::before {
    content: "‘";
}
.css::after, .property::after, .descriptor::after {
    content: "’";
}
.property, .descriptor {
    /* Don't wrap property and descriptor names */
    white-space: nowrap;
}
.type { /* CSS value <type> */
    font-style: italic;
}
pre .property::before, pre .property::after {
    content: "";
}
[data-link-type="property"]::before,
[data-link-type="propdesc"]::before,
[data-link-type="descriptor"]::before,
[data-link-type="value"]::before,
[data-link-type="function"]::before,
[data-link-type="at-rule"]::before,
[data-link-type="selector"]::before,
[data-link-type="maybe"]::before {
    content: "‘";
}
[data-link-type="property"]::after,
[data-link-type="propdesc"]::after,
[data-link-type="descriptor"]::after,
[data-link-type="value"]::after,
[data-link-type="function"]::after,
[data-link-type="at-rule"]::after,
[data-link-type="selector"]::after,
[data-link-type="maybe"]::after {
    content: "’";
}

[data-link-type].production::before,
[data-link-type].production::after,
.prod [data-link-type]::before,
.prod [data-link-type]::after {
    content: "";
}

[data-link-type=element],
[data-link-type=element-attr] {
    font-family: Menlo, Consolas, "DejaVu Sans Mono", monospace;
    font-size: .9em;
}
[data-link-type=element]::before { content: "<" }
[data-link-type=element]::after  { content: ">" }

[data-link-type=biblio] {
    white-space: pre;
}

@media (prefers-color-scheme: dark) {
    :root {
        --selflink-text: black;
        --selflink-bg: silver;
        --selflink-hover-text: white;
    }
}
</style>
<style>/* Boilerplate: style-colors */

/* Any --*-text not paired with a --*-bg is assumed to have a transparent bg */
:root {
    color-scheme: light dark;

    --text: black;
    --bg: white;

    --unofficial-watermark: url(https://www.w3.org/StyleSheets/TR/2016/logos/UD-watermark);

    --logo-bg: #1a5e9a;
    --logo-active-bg: #c00;
    --logo-text: white;

    --tocnav-normal-text: #707070;
    --tocnav-normal-bg: var(--bg);
    --tocnav-hover-text: var(--tocnav-normal-text);
    --tocnav-hover-bg: #f8f8f8;
    --tocnav-active-text: #c00;
    --tocnav-active-bg: var(--tocnav-normal-bg);

    --tocsidebar-text: var(--text);
    --tocsidebar-bg: #f7f8f9;
    --tocsidebar-shadow: rgba(0,0,0,.1);
    --tocsidebar-heading-text: hsla(203,20%,40%,.7);

    --toclink-text: var(--text);
    --toclink-underline: #3980b5;
    --toclink-visited-text: var(--toclink-text);
    --toclink-visited-underline: #054572;

    --heading-text: #005a9c;

    --hr-text: var(--text);

    --algo-border: #def;

    --del-text: red;
    --del-bg: transparent;
    --ins-text: #080;
    --ins-bg: transparent;

    --a-normal-text: #034575;
    --a-normal-underline: #bbb;
    --a-visited-text: var(--a-normal-text);
    --a-visited-underline: #707070;
    --a-hover-bg: rgba(75%, 75%, 75%, .25);
    --a-active-text: #c00;
    --a-active-underline: #c00;

    --blockquote-border: silver;
    --blockquote-bg: transparent;
    --blockquote-text: currentcolor;

    --issue-border: #e05252;
    --issue-bg: #fbe9e9;
    --issue-text: var(--text);
    --issueheading-text: #831616;

    --example-border: #e0cb52;
    --example-bg: #fcfaee;
    --example-text: var(--text);
    --exampleheading-text: #574b0f;

    --note-border: #52e052;
    --note-bg: #e9fbe9;
    --note-text: var(--text);
    --noteheading-text: hsl(120, 70%, 30%);
    --notesummary-underline: silver;

    --assertion-border: #aaa;
    --assertion-bg: #eee;
    --assertion-text: black;

    --advisement-border: orange;
    --advisement-bg: #fec;
    --advisement-text: var(--text);
    --advisementheading-text: #b35f00;

    --warning-border: red;
    --warning-bg: hsla(40,100%,50%,0.95);
    --warning-text: var(--text);

    --amendment-border: #330099;
    --amendment-bg: #F5F0FF;
    --amendment-text: var(--text);
    --amendmentheading-text: #220066;

    --def-border: #8ccbf2;
    --def-bg: #def;
    --def-text: var(--text);
    --defrow-border: #bbd7e9;

    --datacell-border: silver;

    --indexinfo-text: #707070;

    --indextable-hover-text: black;
    --indextable-hover-bg: #f7f8f9;

    --outdatedspec-bg: rgba(0, 0, 0, .5);
    --outdatedspec-text: black;
    --outdated-bg: maroon;
    --outdated-text: white;
    --outdated-shadow: red;

    --editedrec-bg: darkorange;
}

@media (prefers-color-scheme: dark) {
    :root {
        --text: #ddd;
        --bg: black;

        --unofficial-watermark: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='400'%3E%3Cg fill='%23100808' transform='translate(200 200) rotate(-45) translate(-200 -200)' stroke='%23100808' stroke-width='3'%3E%3Ctext x='50%25' y='220' style='font: bold 70px sans-serif; text-anchor: middle; letter-spacing: 6px;'%3EUNOFFICIAL%3C/text%3E%3Ctext x='50%25' y='305' style='font: bold 70px sans-serif; text-anchor: middle; letter-spacing: 6px;'%3EDRAFT%3C/text%3E%3C/g%3E%3C/svg%3E");

        --logo-bg: #1a5e9a;
        --logo-active-bg: #c00;
        --logo-text: white;

        --tocnav-normal-text: #999;
        --tocnav-normal-bg: var(--bg);
        --tocnav-hover-text: var(--tocnav-normal-text);
        --tocnav-hover-bg: #080808;
        --tocnav-active-text: #f44;
        --tocnav-active-bg: var(--tocnav-normal-bg);

        --tocsidebar-text: var(--text);
        --tocsidebar-bg: #080808;
        --tocsidebar-shadow: rgba(255,255,255,.1);
        --tocsidebar-heading-text: hsla(203,20%,40%,.7);

        --toclink-text: var(--text);
        --toclink-underline: #6af;
        --toclink-visited-text: var(--toclink-text);
        --toclink-visited-underline: #054572;

        --heading-text: #8af;

        --hr-text: var(--text);

        --algo-border: #456;

        --del-text: #f44;
        --del-bg: transparent;
        --ins-text: #4a4;
        --ins-bg: transparent;

        --a-normal-text: #6af;
        --a-normal-underline: #555;
        --a-visited-text: var(--a-normal-text);
        --a-visited-underline: var(--a-normal-underline);
        --a-hover-bg: rgba(25%, 25%, 25%, .2);
        --a-active-text: #f44;
        --a-active-underline: var(--a-active-text);

        --borderedblock-bg: rgba(255, 255, 255, .05);

        --blockquote-border: silver;
        --blockquote-bg: var(--borderedblock-bg);
        --blockquote-text: currentcolor;

        --issue-border: #e05252;
        --issue-bg: var(--borderedblock-bg);
        --issue-text: var(--text);
        --issueheading-text: hsl(0deg, 70%, 70%);

        --example-border: hsl(50deg, 90%, 60%);
        --example-bg: var(--borderedblock-bg);
        --example-text: var(--text);
        --exampleheading-text: hsl(50deg, 70%, 70%);

        --note-border: hsl(120deg, 100%, 35%);
        --note-bg: var(--borderedblock-bg);
        --note-text: var(--text);
        --noteheading-text: hsl(120, 70%, 70%);
        --notesummary-underline: silver;

        --assertion-border: #444;
        --assertion-bg: var(--borderedblock-bg);
        --assertion-text: var(--text);

        --advisement-border: orange;
        --advisement-bg: #222218;
        --advisement-text: var(--text);
        --advisementheading-text: #f84;

        --warning-border: red;
        --warning-bg: hsla(40,100%,20%,0.95);
        --warning-text: var(--text);

        --amendment-border: #330099;
        --amendment-bg: #080010;
        --amendment-text: var(--text);
        --amendmentheading-text: #cc00ff;

        --def-border: #8ccbf2;
        --def-bg: #080818;
        --def-text: var(--text);
        --defrow-border: #136;

        --datacell-border: silver;

        --indexinfo-text: #aaa;

        --indextable-hover-text: var(--text);
        --indextable-hover-bg: #181818;

        --outdatedspec-bg: rgba(255, 255, 255, .5);
        --outdatedspec-text: black;
        --outdated-bg: maroon;
        --outdated-text: white;
        --outdated-shadow: red;

        --editedrec-bg: darkorange;
    }
    /* In case a transparent-bg image doesn't expect to be on a dark bg,
       which is quite common in practice... */
    img { background: white; }
}
</style>
<style>/* Boilerplate: style-counters */
body {
    counter-reset: example figure issue;
}
.issue {
    counter-increment: issue;
}
.issue:not(.no-marker)::before {
    content: "Issue " counter(issue);
}

.example {
    counter-increment: example;
}
.example:not(.no-marker)::before {
    content: "Example " counter(example);
}
.invalid.example:not(.no-marker)::before,
.illegal.example:not(.no-marker)::before {
    content: "Invalid Example" counter(example);
}

figcaption {
    counter-increment: figure;
}
figcaption:not(.no-marker)::before {
    content: "Figure " counter(figure) " ";
}
</style>
<style>/* Boilerplate: style-dfn-panel */
:root {
    --dfnpanel-bg: #ddd;
    --dfnpanel-text: var(--text);
}
@media (prefers-color-scheme: dark) {
    :root {
        --dfnpanel-bg: #222;
        --dfnpanel-text: var(--text);
    }
}
.dfn-panel {
    position: absolute;
    z-index: 35;
    width: 20em;
    width: 300px;
    height: auto;
    max-height: 500px;
    overflow: auto;
    padding: 0.5em 0.75em;
    font: small Helvetica Neue, sans-serif, Droid Sans Fallback;
    background: var(--dfnpanel-bg);
    color: var(--dfnpanel-text);
    border: outset 0.2em;
    white-space: normal; /* in case it's moved into a pre */
}
.dfn-panel:not(.on) { display: none; }
.dfn-panel * { margin: 0; padding: 0; text-indent: 0; }
.dfn-panel > b { display: block; }
.dfn-panel a { color: var(--dfnpanel-text); }
.dfn-panel a:not(:hover) { text-decoration: none !important; border-bottom: none !important; }
.dfn-panel > b + b { margin-top: 0.25em; }
.dfn-panel ul { padding: 0 0 0 1em; list-style: none; }
.dfn-panel li a {
    white-space: pre;
    display: inline-block;
    max-width: calc(300px - 1.5em - 1em);
    overflow: hidden;
    text-overflow: ellipsis;
}

.dfn-panel.activated {
    display: inline-block;
    position: fixed;
    left: .5em;
    bottom: 2em;
    margin: 0 auto;
    max-width: calc(100vw - 1.5em - .4em - .5em);
    max-height: 30vh;
}

.dfn-paneled[role="button"] { cursor: pointer; }
</style>
<style>/* Boilerplate: style-dfn-panel */
:root {
    --dfnpanel-bg: #ddd;
    --dfnpanel-text: var(--text);
}
@media (prefers-color-scheme: dark) {
    :root {
        --dfnpanel-bg: #222;
        --dfnpanel-text: var(--text);
    }
}
.dfn-panel {
    position: absolute;
    z-index: 35;
    width: 20em;
    width: 300px;
    height: auto;
    max-height: 500px;
    overflow: auto;
    padding: 0.5em 0.75em;
    font: small Helvetica Neue, sans-serif, Droid Sans Fallback;
    background: var(--dfnpanel-bg);
    color: var(--dfnpanel-text);
    border: outset 0.2em;
    white-space: normal; /* in case it's moved into a pre */
}
.dfn-panel:not(.on) { display: none; }
.dfn-panel * { margin: 0; padding: 0; text-indent: 0; }
.dfn-panel > b { display: block; }
.dfn-panel a { color: var(--dfnpanel-text); }
.dfn-panel a:not(:hover) { text-decoration: none !important; border-bottom: none !important; }
.dfn-panel > b + b { margin-top: 0.25em; }
.dfn-panel ul { padding: 0 0 0 1em; list-style: none; }
.dfn-panel li a {
    white-space: pre;
    display: inline-block;
    max-width: calc(300px - 1.5em - 1em);
    overflow: hidden;
    text-overflow: ellipsis;
}

.dfn-panel.activated {
    display: inline-block;
    position: fixed;
    left: .5em;
    bottom: 2em;
    margin: 0 auto;
    max-width: calc(100vw - 1.5em - .4em - .5em);
    max-height: 30vh;
}

.dfn-paneled[role="button"] { cursor: pointer; }
</style>
<style>/* Boilerplate: style-issues */
a[href].issue-return {
    float: right;
    float: inline-end;
    color: var(--issueheading-text);
    font-weight: bold;
    text-decoration: none;
}
</style>
<style>/* Boilerplate: style-md-lists */
/* This is a weird hack for me not yet following the commonmark spec
   regarding paragraph and lists. */
[data-md] > :first-child {
    margin-top: 0;
}
[data-md] > :last-child {
    margin-bottom: 0;
}
</style>
<style>/* Boilerplate: style-selflinks */

:root {
    --selflink-text: white;
    --selflink-bg: gray;
    --selflink-hover-text: black;
}
.heading, .issue, .note, .example, li, dt {
    position: relative;
}
a.self-link {
    position: absolute;
    top: 0;
    left: calc(-1 * (3.5rem - 26px));
    width: calc(3.5rem - 26px);
    height: 2em;
    text-align: center;
    border: none;
    transition: opacity .2s;
    opacity: .5;
}
a.self-link:hover {
    opacity: 1;
}
.heading > a.self-link {
    font-size: 83%;
}
.example > a.self-link,
.note > a.self-link,
.issue > a.self-link {
    /* These blocks are overflow:auto, so positioning outside
       doesn't work. */
    left: auto;
    right: 0;
}
li > a.self-link {
    left: calc(-1 * (3.5rem - 26px) - 2em);
}
dfn > a.self-link {
    top: auto;
    left: auto;
    opacity: 0;
    width: 1.5em;
    height: 1.5em;
    background: var(--selflink-bg);
    color: var(--selflink-text);
    font-style: normal;
    transition: opacity .2s, background-color .2s, color .2s;
}
dfn:hover > a.self-link {
    opacity: 1;
}
dfn > a.self-link:hover {
    color: var(--selflink-hover-text);
}

a.self-link::before            { content: "¶"; }
.heading > a.self-link::before { content: "§"; }
dfn > a.self-link::before      { content: "#"; }
</style>
 <body class="h-entry">
  <div class="head">
   <p data-fill-with="logo"><a class="logo" href="https://www.w3.org/"> <img alt="W3C" height="48" src="https://www.w3.org/StyleSheets/TR/2021/logos/W3C" width="72"> </a> </p>
   <h1>Private Network Access</h1>
   <p id="w3c-state"><a href="https://www.w3.org/standards/types#CG-DRAFT">Draft Community Group Report</a>, <time class="dt-updated" datetime="2023-06-08">8 June 2023</time></p>
   <div data-fill-with="spec-metadata">
    <dl>
     <dt>This version:
     <dd><a class="u-url" href="https://wicg.github.io/private-network-access/">https://wicg.github.io/private-network-access/</a>
     <dt>Issue Tracking:
     <dd><a href="https://github.com/wicg/private-network-access/issues/">GitHub</a>
     <dd><a href="#issues-index">Inline In Spec</a>
     <dt class="editor">Editor:
     <dd class="editor p-author h-card vcard" data-editor-id="124486"><a class="p-name fn u-email email" href="mailto:titouan@google.com">Titouan Rigoudy</a> (<span class="p-org org">Google</span>)
     <dt class="editor">Former Editor:
     <dd class="editor p-author h-card vcard" data-editor-id="56384"><a class="p-name fn u-email email" href="mailto:mkwst@google.com">Mike West</a> (<span class="p-org org">Google</span>)
    </dl>
   </div>
   <div data-fill-with="warning"></div>
   <p class="copyright" data-fill-with="copyright"><a href="http://www.w3.org/Consortium/Legal/ipr-notice#Copyright">Copyright</a> © 2023 the Contributors to the Private Network Access Specification, published by the <a href="https://www.w3.org/community/wicg/">Web Platform Incubator Community Group</a> under the <a href="https://www.w3.org/community/about/agreements/cla/">W3C Community Contributor License Agreement (CLA)</a>.
A human-readable <a href="http://www.w3.org/community/about/agreements/cla-deed/">summary</a> is available. </p>
   <hr title="Separator for header">
  </div>
  <div class="p-summary" data-fill-with="abstract">
   <h2 class="no-num no-toc no-ref heading settled" id="abstract"><span class="content">Abstract</span></h2>
   <p>This document specifies modifications to Fetch and HTML which are intended to

  mitigate the risks associated with unintentional exposure of devices and
  servers on a client’s internal network to the web at large.</p>
   <p>This specification was previously known as CORS-RFC1918.</p>
  </div>
  <div data-fill-with="at-risk"></div>
  <h2 class="no-num no-toc no-ref heading settled" id="status"><span class="content">Status of this document</span></h2>
  <div data-fill-with="status">
   <p> This specification was published by the <a href="https://www.w3.org/community/wicg/">Web Platform Incubator Community Group</a>.
  It is not a W3C Standard nor is it on the W3C Standards Track.

  Please note that under the <a href="https://www.w3.org/community/about/agreements/cla/">W3C Community Contributor License Agreement (CLA)</a> there is a limited opt-out and other conditions apply.

  Learn more about <a href="http://www.w3.org/community/">W3C Community and Business Groups</a>. </p>
   <p></p>
  </div>
  <div data-fill-with="at-risk"></div>
  <nav data-fill-with="table-of-contents" id="toc">
   <h2 class="no-num no-toc no-ref" id="contents">Table of Contents</h2>
   <ol class="toc" role="directory">
    <li>
     <a href="#intro"><span class="secno">1</span> <span class="content">Introduction</span></a>
     <ol class="toc">
      <li><a href="#goals"><span class="secno">1.1</span> <span class="content">Goals</span></a>
      <li>
       <a href="#examples"><span class="secno">1.2</span> <span class="content">Examples</span></a>
       <ol class="toc">
        <li><a href="#example-deny-by-default"><span class="secno">1.2.1</span> <span class="content">Secure by Default</span></a>
        <li><a href="#example-opt-in"><span class="secno">1.2.2</span> <span class="content">Opting-In</span></a>
        <li><a href="#shortlinks"><span class="secno">1.2.3</span> <span class="content">Navigation</span></a>
       </ol>
     </ol>
    <li>
     <a href="#framework"><span class="secno">2</span> <span class="content">Framework</span></a>
     <ol class="toc">
      <li><a href="#ip-address-space-heading"><span class="secno">2.1</span> <span class="content">IP Address Space</span></a>
      <li><a href="#private-network-request-heading"><span class="secno">2.2</span> <span class="content">Private Network Request</span></a>
      <li><a href="#headers"><span class="secno">2.3</span> <span class="content">Additional CORS Headers</span></a>
      <li><a href="#csp"><span class="secno">2.4</span> <span class="content">The <code>treat-as-public-address</code> Content Security Policy Directive</span></a>
      <li><a href="#feature-detect"><span class="secno">2.5</span> <span class="content">Feature Detection</span></a>
     </ol>
    <li>
     <a href="#integrations"><span class="secno">3</span> <span class="content">Integrations</span></a>
     <ol class="toc">
      <li>
       <a href="#integration-fetch"><span class="secno">3.1</span> <span class="content">Integration with Fetch</span></a>
       <ol class="toc">
        <li><a href="#secure-context-restriction"><span class="secno">3.1.1</span> <span class="content">Secure context restriction</span></a>
        <li><a href="#cors-preflight"><span class="secno">3.1.2</span> <span class="content">CORS preflight</span></a>
        <li><a href="#forbidden-header-names"><span class="secno">3.1.3</span> <span class="content">Forbidden header names</span></a>
       </ol>
      <li><a href="#integration-websockets"><span class="secno">3.2</span> <span class="content">Integration with WebSockets</span></a>
      <li><a href="#integration-html"><span class="secno">3.3</span> <span class="content">Integration with HTML</span></a>
      <li><a href="#workers"><span class="secno">3.4</span> <span class="content">Workers</span></a>
     </ol>
    <li>
     <a href="#implementation-considerations"><span class="secno">4</span> <span class="content">Implementation Considerations</span></a>
     <ol class="toc">
      <li><a href="#file-url"><span class="secno">4.1</span> <span class="content">Where do <code>file</code> URLs fit?</span></a>
      <li><a href="#proxies"><span class="secno">4.2</span> <span class="content">Proxies</span></a>
      <li>
       <a href="#http-cache"><span class="secno">4.3</span> <span class="content">HTTP Cache</span></a>
       <ol class="toc">
        <li><a href="#http-cache-main-resources"><span class="secno">4.3.1</span> <span class="content">Main resources</span></a>
        <li><a href="#http-cache-subresources"><span class="secno">4.3.2</span> <span class="content">Subresources</span></a>
       </ol>
      <li><a href="#rollout-difficulties"><span class="secno">4.4</span> <span class="content">Rollout difficulties</span></a>
     </ol>
    <li>
     <a href="#security-and-privacy-considerations"><span class="secno">5</span> <span class="content">Security and Privacy Considerations</span></a>
     <ol class="toc">
      <li><a href="#user-mediation"><span class="secno">5.1</span> <span class="content">User Mediation</span></a>
      <li><a href="#mixed-content"><span class="secno">5.2</span> <span class="content">Mixed Content</span></a>
      <li><a href="#dns-rebinding"><span class="secno">5.3</span> <span class="content">DNS Rebinding</span></a>
      <li><a href="#scope-mitigation"><span class="secno">5.4</span> <span class="content">Scope of Mitigation</span></a>
      <li><a href="#cross-network-confusion"><span class="secno">5.5</span> <span class="content">Cross-network confusion</span></a>
      <li>
       <a href="#http-cache-security"><span class="secno">5.6</span> <span class="content">HTTP cache</span></a>
       <ol class="toc">
        <li><a href="#http-cache-security-subresources"><span class="secno">5.6.1</span> <span class="content">Applying checks to subresources</span></a>
        <li><a href="#http-cache-poisoning"><span class="secno">5.6.2</span> <span class="content">HTTP cache poisoning</span></a>
       </ol>
     </ol>
    <li><a href="#iana-considerations"><span class="secno">6</span> <span class="content">IANA Considerations</span></a>
    <li><a href="#acknowledgements"><span class="secno">7</span> <span class="content">Acknowledgements</span></a>
    <li>
     <a href="#index"><span class="secno"></span> <span class="content">Index</span></a>
     <ol class="toc">
      <li><a href="#index-defined-here"><span class="secno"></span> <span class="content">Terms defined by this specification</span></a>
      <li><a href="#index-defined-elsewhere"><span class="secno"></span> <span class="content">Terms defined by reference</span></a>
     </ol>
    <li>
     <a href="#references"><span class="secno"></span> <span class="content">References</span></a>
     <ol class="toc">
      <li><a href="#normative"><span class="secno"></span> <span class="content">Normative References</span></a>
      <li><a href="#informative"><span class="secno"></span> <span class="content">Informative References</span></a>
     </ol>
    <li><a href="#issues-index"><span class="secno"></span> <span class="content">Issues Index</span></a>
   </ol>
  </nav>
  <main>
   <section>
    <h2 class="heading settled" data-level="1" id="intro"><span class="secno">1. </span><span class="content">Introduction</span><a class="self-link" href="#intro"></a></h2>
    <p><em>This section is not normative.</em></p>
    <p>Although <a data-link-type="biblio" href="#biblio-rfc1918" title="Address Allocation for Private Internets">[RFC1918]</a> has specified a distinction between "private" and
  "public" internet addresses for over two decades, user agents haven’t made
  much progress at segregating the one from the other. Websites on the public
  internet can make requests to internal devices and servers, which enable a
  number of malicious behaviors, including attacks on users' routers like those
  documented in <a data-link-type="biblio" href="#biblio-drive-by-pharming" title="Drive-By Pharming">[DRIVE-BY-PHARMING]</a>, <a data-link-type="biblio" href="#biblio-soho-pharming" title="SOHO Pharming">[SOHO-PHARMING]</a> and <a data-link-type="biblio" href="#biblio-csrf-exploit-kit" title="An Exploit Kit dedicated to CSRF Pharming">[CSRF-EXPLOIT-KIT]</a>.</p>
    <p>Here, we propose a mitigation against these kinds of attacks that would
  require internal devices to explicitly opt-in to requests from the public
  internet.</p>
    <h3 class="heading settled" data-level="1.1" id="goals"><span class="secno">1.1. </span><span class="content">Goals</span><a class="self-link" href="#goals"></a></h3>
    <p>The overarching goal is to prevent the user agent from inadvertently enabling
  attacks on devices running on a user’s local intranet, or services running on
  the user’s machine directly. For example, we wish to mitigate attacks on:</p>
    <ul>
     <li data-md>
      <p>Users' routers, as outlined in <a data-link-type="biblio" href="#biblio-soho-pharming" title="SOHO Pharming">[SOHO-PHARMING]</a>. Note that status quo
  CORS protections don’t protect against the kinds of attacks discussed here
  as they rely only on <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#cors-safelisted-method" id="ref-for-cors-safelisted-method">CORS-safelisted methods</a> and <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#cors-safelisted-request-header" id="ref-for-cors-safelisted-request-header">CORS-safelisted request-headers</a>. No preflight is triggered, and the
  attacker doesn’t actually care about reading the response, as the request
  itself is the CSRF attack.</p>
     <li data-md>
      <p>Software running a web interface on a user’s loopback address. For better
  or worse, this is becoming a common deployment mechanism for all manner of
  applications, and often assumes protections that simply don’t exist (see <a data-link-type="biblio" href="#biblio-avastium" title="Avast: A web-accessible RPC endpoint can launch &apos;SafeZone&apos; (also called Avastium), a Chromium fork with critical security checks removed.">[AVASTIUM]</a> and <a data-link-type="biblio" href="#biblio-trend-micro" title="TrendMicro node.js HTTP server listening on localhost can execute commands">[TREND-MICRO]</a> for recent examples).</p>
    </ul>
    <h3 class="heading settled" data-level="1.2" id="examples"><span class="secno">1.2. </span><span class="content">Examples</span><a class="self-link" href="#examples"></a></h3>
    <h4 class="heading settled" data-level="1.2.1" id="example-deny-by-default"><span class="secno">1.2.1. </span><span class="content">Secure by Default</span><a class="self-link" href="#example-deny-by-default"></a></h4>
    <div class="example" id="example-262fae93">
     <a class="self-link" href="#example-262fae93"></a> MegaCorp Inc’s routers have a fairly serious CSRF vulnerability which allows
    their DNS settings to be altered by navigating to <code>http://admin:admin@router.local/set_dns</code> and passing in various GET
    parameters. Oh noes! 
     <p>Happily, MegaCorp Inc’s routers don’t have any interest in requests from the
    public internet, and didn’t take any special effort to enable them. This
    greatly mitigates the scope of the vulnerability, as malicious requests will
    generate a <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#cors-preflight-request" id="ref-for-cors-preflight-request">CORS-preflight request</a>, which the router ignores. Let’s
    take a closer look:</p>
     <p>Given <code>https://csrf.attack/</code> that contains the following HTML:</p>
<pre>&lt;iframe href="https://admin:admin@router.local/set_dns?server1=123.123.123.123">
&lt;/iframe>
</pre>
     <p><code>router.local</code> will be resolved to the router’s address via the magic of
    multicast DNS <a data-link-type="biblio" href="#biblio-rfc6762" title="Multicast DNS">[RFC6762]</a>, and the user agent will note it as <a data-link-type="dfn" href="#ip-address-space-private" id="ref-for-ip-address-space-private">private</a>. Since <code>csrf.attack</code> resolved to a <a data-link-type="dfn" href="#public-address" id="ref-for-public-address">public address</a>, the request will trigger a <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#cors-preflight-request" id="ref-for-cors-preflight-request①">CORS-preflight request</a>:</p>
<pre>OPTIONS /set_dns?... HTTP/1.1
Host: router.local
<a data-link-type="http-header" href="https://fetch.spec.whatwg.org/#http-access-control-request-method" id="ref-for-http-access-control-request-method">Access-Control-Request-Method</a>: GET
<a data-link-type="http-header" href="#http-headerdef-access-control-request-private-network" id="ref-for-http-headerdef-access-control-request-private-network">Access-Control-Request-Private-Network</a>: true
...
Origin: https://csrf.attack
</pre>
     <p>The router will receive this <code>OPTIONS</code> request, and has a number of possible
    safe responses:</p>
     <ul>
      <li data-md>
       <p>If it doesn’t understand <code>OPTIONS</code> at all, it can return a <code>50X</code> error.
  This will cause the preflight to fail, and the actual <code>GET</code> will never
  be issued.</p>
      <li data-md>
       <p>If it does understand <code>OPTIONS</code>, it can neglect to include an <a data-link-type="http-header" href="#http-headerdef-access-control-allow-private-network" id="ref-for-http-headerdef-access-control-allow-private-network"><code>Access-Control-Allow-Private-Network</code></a> header in its
  response. This will cause the preflight to fail, and the actual <code>GET</code> will never be issued.</p>
      <li data-md>
       <p>It can crash. Crashing is fairly safe, if inelegant.</p>
     </ul>
    </div>
    <h4 class="heading settled" data-level="1.2.2" id="example-opt-in"><span class="secno">1.2.2. </span><span class="content">Opting-In</span><a class="self-link" href="#example-opt-in"></a></h4>
    <div class="example" id="example-6ce42a93">
     <a class="self-link" href="#example-6ce42a93"></a> Some of MegaCorp Inc’s devices actually need to talk to the public internet
    for various reasons. They can explicitly opt-in to receiving requests from
    the internet by sending proper CORS headers in response to a <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#cors-preflight-request" id="ref-for-cors-preflight-request②">CORS-preflight request</a>. 
     <p>When a website on the public internet makes a request to the device, the
    user agent determines that the requestor is <a data-link-type="dfn" href="#ip-address-space-public" id="ref-for-ip-address-space-public">public</a>, and
    the router is <a data-link-type="dfn" href="#ip-address-space-private" id="ref-for-ip-address-space-private①">private</a>. This means that requests will
    trigger a <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#cors-preflight-request" id="ref-for-cors-preflight-request③">CORS-preflight request</a>, just as above.</p>
     <p>The device can explicitly grant access by sending the right headers in its
    response to the preflight request. For the above request, that might look
    like:</p>
<pre>HTTP/1.1 200 OK
...
<a data-link-type="http-header" href="https://fetch.spec.whatwg.org/#http-access-control-allow-origin" id="ref-for-http-access-control-allow-origin">Access-Control-Allow-Origin</a>: https://public.example.com
<a data-link-type="http-header" href="https://fetch.spec.whatwg.org/#http-access-control-allow-methods" id="ref-for-http-access-control-allow-methods">Access-Control-Allow-Methods</a>: GET
<a data-link-type="http-header" href="https://fetch.spec.whatwg.org/#http-access-control-allow-credentials" id="ref-for-http-access-control-allow-credentials">Access-Control-Allow-Credentials</a>: true
<a data-link-type="http-header" href="#http-headerdef-access-control-allow-private-network" id="ref-for-http-headerdef-access-control-allow-private-network①">Access-Control-Allow-Private-Network</a>: true
Content-Length: 0
...
</pre>
    </div>
    <h4 class="heading settled" data-level="1.2.3" id="shortlinks"><span class="secno">1.2.3. </span><span class="content">Navigation</span><a class="self-link" href="#shortlinks"></a></h4>
    <div class="example" id="example-e45f5be8">
     <a class="self-link" href="#example-e45f5be8"></a> MegaCorp Inc. runs an internal link shortening service at <code>https://go/</code>, and
    its employees often email such links to each other. The email server is
    hosted at a <a data-link-type="dfn" href="#public-address" id="ref-for-public-address①">public address</a> in order to ensure that employees can work
    even when they’re not at the office. How considerate! 
     <p>Clicking <code>https://go/*</code> links from <code>https://mail.mega.corp/</code> will trigger a <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#cors-preflight-request" id="ref-for-cors-preflight-request④">CORS-preflight request</a>, as it is a request from a <a data-link-type="dfn" href="#public-address" id="ref-for-public-address②">public
    address</a> to a <a data-link-type="dfn" href="#private-address" id="ref-for-private-address">private address</a>:</p>
<pre>OPTIONS /short-links-are-short-after-shortening HTTP/1.1
Host: go
<a data-link-type="http-header" href="https://fetch.spec.whatwg.org/#http-access-control-request-method" id="ref-for-http-access-control-request-method①">Access-Control-Request-Method</a>: GET
<a data-link-type="http-header" href="#http-headerdef-access-control-request-private-network" id="ref-for-http-headerdef-access-control-request-private-network①">Access-Control-Request-Private-Network</a>: true
...
Origin: https://mail.mega.corp
</pre>
     <p>In order to ensure that employees can continue to navigate such links as
    expected, MegaCorp chooses to allow private network requests:</p>
<pre>HTTP/1.1 200 OK
...
<a data-link-type="http-header" href="https://fetch.spec.whatwg.org/#http-access-control-allow-origin" id="ref-for-http-access-control-allow-origin①">Access-Control-Allow-Origin</a>: https://mail.mega.corp
<a data-link-type="http-header" href="https://fetch.spec.whatwg.org/#http-access-control-allow-methods" id="ref-for-http-access-control-allow-methods①">Access-Control-Allow-Methods</a>: GET
<a data-link-type="http-header" href="https://fetch.spec.whatwg.org/#http-access-control-allow-credentials" id="ref-for-http-access-control-allow-credentials①">Access-Control-Allow-Credentials</a>: true
<a data-link-type="http-header" href="#http-headerdef-access-control-allow-private-network" id="ref-for-http-headerdef-access-control-allow-private-network②">Access-Control-Allow-Private-Network</a>: true
Content-Length: 0
...
</pre>
     <p>MegaCorp’s leak-prevention department is worried, though, that this access
    will allow external folks to read the location of any redirect that the
    shortener would return. They’re more or less resigned to the fact that <code>https://go/shortlink</code> will leak, but would be sad indeed if the target
    (<code>https://sekrits/super-sekrit-project-with-super-sekrit-partner</code>) leaked
    as well.</p>
     <p>MegaCorp’s shortlink engineers are careful to avoid this potential failure
    by returning CORS headers <em>only</em> for the preflight. The "real"
    navigation doesn’t require CORS headers, and they don’t actually want to
    support cross-origin requests as being CORS-same-origin:</p>
<pre>// Request:
GET /short-links-are-short-after-shortening HTTP/1.1
Host: go
...

// Response:
HTTP/1.1 301 Moved Permanently
...
Location: https://sekrits/super-sekrit-project-with-super-sekrit-partner
</pre>
     <p>The navigation will proceed normally, but <code>mail.mega.corp</code> won’t be
    considered CORS-same-origin with the response.</p>
    </div>
   </section>
   <section>
    <h2 class="heading settled" data-level="2" id="framework"><span class="secno">2. </span><span class="content">Framework</span><a class="self-link" href="#framework"></a></h2>
    <h3 class="heading settled" data-level="2.1" id="ip-address-space-heading"><span class="secno">2.1. </span><span class="content">IP Address Space</span><a class="self-link" href="#ip-address-space-heading"></a></h3>
    <p>Every IP address belongs to an <dfn class="dfn-paneled" data-dfn-type="dfn" data-export data-local-lt="address space" id="ip-address-space">IP address space</dfn>, which can be one
  of three different values:</p>
    <ol>
     <li data-md>
      <p><dfn class="dfn-paneled" data-dfn-for="IP address space" data-dfn-type="dfn" data-export id="ip-address-space-local">local</dfn>: contains the local
  host only. In other words, addresses whose target differs for every
  device.</p>
     <li data-md>
      <p><dfn class="dfn-paneled" data-dfn-for="IP address space" data-dfn-type="dfn" data-export id="ip-address-space-private">private</dfn>: contains
  addresses that have meaning only within the current network. In other
  words, addresses whose target differs based on network position.</p>
     <li data-md>
      <p><dfn class="dfn-paneled" data-dfn-for="IP address space" data-dfn-type="dfn" data-export id="ip-address-space-public">public</dfn>: contains all
  other addresses. In other words, addresses whose target is the same for
  all devices globally on the IP network.</p>
    </ol>
    <p>For convenience, we additionally define the following terms:</p>
    <ol>
     <li data-md>
      <p>A <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="local-address">local address</dfn> is an IP address whose <a data-link-type="dfn" href="#ip-address-space" id="ref-for-ip-address-space">IP address space</a> is <a data-link-type="dfn" href="#ip-address-space-local" id="ref-for-ip-address-space-local">local</a>.</p>
     <li data-md>
      <p>A <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="private-address">private address</dfn> is an IP address whose <a data-link-type="dfn" href="#ip-address-space" id="ref-for-ip-address-space①">IP address space</a> is <a data-link-type="dfn" href="#ip-address-space-private" id="ref-for-ip-address-space-private②">private</a>.</p>
     <li data-md>
      <p>A <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="public-address">public address</dfn> is an IP address whose <a data-link-type="dfn" href="#ip-address-space" id="ref-for-ip-address-space②">IP address space</a> is <a data-link-type="dfn" href="#ip-address-space-public" id="ref-for-ip-address-space-public①">public</a>.</p>
    </ol>
    <p>An <a data-link-type="dfn" href="#ip-address-space" id="ref-for-ip-address-space③">IP address space</a> <var>lhs</var> is <dfn class="dfn-paneled" data-dfn-for="IP address space" data-dfn-type="dfn" data-export id="ip-address-space-less-public">less public</dfn> than an <a data-link-type="dfn" href="#ip-address-space" id="ref-for-ip-address-space④">IP address space</a> <var>rhs</var> if any of the following conditions holds true:</p>
    <ol>
     <li data-md>
      <p><var>lhs</var> is <a data-link-type="dfn" href="#ip-address-space-local" id="ref-for-ip-address-space-local①">local</a> and <var>rhs</var> is either <a data-link-type="dfn" href="#ip-address-space-private" id="ref-for-ip-address-space-private③">private</a> or <a data-link-type="dfn" href="#ip-address-space-public" id="ref-for-ip-address-space-public②">public</a>.</p>
     <li data-md>
      <p><var>lhs</var> is <a data-link-type="dfn" href="#ip-address-space-private" id="ref-for-ip-address-space-private④">private</a> and <var>rhs</var> is <a data-link-type="dfn" href="#ip-address-space-public" id="ref-for-ip-address-space-public③">public</a>.</p>
    </ol>
    <p>To <dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="determine-the-ip-address-space">determine the IP address space</dfn> of an IP address <var>address</var>, run the following steps:</p>
    <ol>
     <li data-md>
      <p>If <var>address</var> belongs to the <code>::ffff:0:0/96</code> "IPv4-mapped Address"
  address block, then replace <var>address</var> with its embedded IPv4 address.</p>
     <li data-md>
      <p>For each <var>row</var> in the <a href="#non-public-ip-address-blocks">Non-public IP address blocks"</a> table:</p>
      <ol>
       <li data-md>
        <p>If <var>address</var> belongs to <var>row</var>’s address block, return <var>row</var>’s
   address space.</p>
      </ol>
     <li data-md>
      <p>Return <a data-link-type="dfn" href="#ip-address-space-public" id="ref-for-ip-address-space-public④">public</a>.</p>
    </ol>
    <table id="non-public-ip-address-blocks">
     <caption>Non-public IP address blocks</caption>
     <thead>
      <tr>
       <th>Address block
       <th>Name
       <th>Reference
       <th>Address space
     <tbody>
      <tr>
       <td><code>127.0.0.0/8</code>
       <td>IPv4 Loopback
       <td><a data-link-type="biblio" href="#biblio-rfc1122" title="Requirements for Internet Hosts - Communication Layers">[RFC1122]</a>
       <td><a data-link-type="dfn" href="#ip-address-space-local" id="ref-for-ip-address-space-local②">local</a>
      <tr>
       <td><code>10.0.0.0/8</code>
       <td>Private Use
       <td><a data-link-type="biblio" href="#biblio-rfc1918" title="Address Allocation for Private Internets">[RFC1918]</a>
       <td><a data-link-type="dfn" href="#ip-address-space-private" id="ref-for-ip-address-space-private⑤">private</a>
      <tr>
       <td><code>100.64.0.0/10</code>
       <td>Carrier-Grade NAT
       <td><a data-link-type="biblio" href="#biblio-rfc6598" title="IANA-Reserved IPv4 Prefix for Shared Address Space">[RFC6598]</a>
       <td><a data-link-type="dfn" href="#ip-address-space-private" id="ref-for-ip-address-space-private⑥">private</a>
      <tr>
       <td><code>172.16.0.0/12</code>
       <td>Private Use
       <td><a data-link-type="biblio" href="#biblio-rfc1918" title="Address Allocation for Private Internets">[RFC1918]</a>
       <td><a data-link-type="dfn" href="#ip-address-space-private" id="ref-for-ip-address-space-private⑦">private</a>
      <tr>
       <td><code>192.168.0.0/16</code>
       <td>Private Use
       <td><a data-link-type="biblio" href="#biblio-rfc1918" title="Address Allocation for Private Internets">[RFC1918]</a>
       <td><a data-link-type="dfn" href="#ip-address-space-private" id="ref-for-ip-address-space-private⑧">private</a>
      <tr>
       <td><code>198.18.0.0/15</code>
       <td>Benchmarking
       <td><a data-link-type="biblio" href="#biblio-rfc2544" title="Benchmarking Methodology for Network Interconnect Devices">[RFC2544]</a>
       <td><a data-link-type="dfn" href="#ip-address-space-local" id="ref-for-ip-address-space-local③">local</a>
      <tr>
       <td><code>169.254.0.0/16</code>
       <td>Link Local
       <td><a data-link-type="biblio" href="#biblio-rfc3927" title="Dynamic Configuration of IPv4 Link-Local Addresses">[RFC3927]</a>
       <td><a data-link-type="dfn" href="#ip-address-space-private" id="ref-for-ip-address-space-private⑨">private</a>
      <tr>
       <td><code>::1/128</code>
       <td>IPv6 Loopback
       <td><a data-link-type="biblio" href="#biblio-rfc4291" title="IP Version 6 Addressing Architecture">[RFC4291]</a>
       <td><a data-link-type="dfn" href="#ip-address-space-local" id="ref-for-ip-address-space-local④">local</a>
      <tr>
       <td><code>fc00::/7</code>
       <td>Unique Local
       <td><a data-link-type="biblio" href="#biblio-rfc4193" title="Unique Local IPv6 Unicast Addresses">[RFC4193]</a>
       <td><a data-link-type="dfn" href="#ip-address-space-private" id="ref-for-ip-address-space-private①⓪">private</a>
      <tr>
       <td><code>fe80::/10</code>
       <td>Link-Local Unicast
       <td><a data-link-type="biblio" href="#biblio-rfc4291" title="IP Version 6 Addressing Architecture">[RFC4291]</a>
       <td><a data-link-type="dfn" href="#ip-address-space-private" id="ref-for-ip-address-space-private①①">private</a>
      <tr>
       <td><code>::ffff:0:0/96</code>
       <td>IPv4-mapped
       <td><a data-link-type="biblio" href="#biblio-rfc4291" title="IP Version 6 Addressing Architecture">[RFC4291]</a>
       <td>see mapped IPv4 address
    </table>
    <p>User Agents MAY allow certain IP address blocks' <a data-link-type="dfn" href="#ip-address-space" id="ref-for-ip-address-space⑤">address space</a> to be
  overridden through administrator or user configuration. This could prove
  useful to protect e.g. IPv6 intranets where most IP addresses are considered <a data-link-type="dfn" href="#ip-address-space-public" id="ref-for-ip-address-space-public⑤">public</a> per the algorithm above, by instead configuring
  user agents to treat the intranet as <a data-link-type="dfn" href="#ip-address-space-private" id="ref-for-ip-address-space-private①②">private</a>.</p>
    <p class="note" role="note"><span class="marker">Note:</span> Link-local IP addresses such as <code>169.254.0.0/16</code> are considered <a data-link-type="dfn" href="#ip-address-space-private" id="ref-for-ip-address-space-private①③">private</a>, since such addresses can identify the same
  target for all devices on a network link. A previous version of this
  specification considered them to be <a data-link-type="dfn" href="#ip-address-space-local" id="ref-for-ip-address-space-local⑤">local</a> instead.</p>
    <p class="note" role="note"><span class="marker">Note:</span> Link-local IP addresses lose their meaning if shared across links. This
  is not fundamentally different from non-public IP addresses, which all have
  some degree of locality beyond which they become ambiguous, but it does
  present a particular risk of confused deputy issues. <a data-link-type="biblio" href="#biblio-link-local-uri" title="Representing IPv6 Zone Identifiers in Address Literals and Uniform Resource Identifiers">[LINK-LOCAL-URI]</a> attempts to solve this problem by defining a syntax for link-local IP
  addresses in URIs.</p>
    <p class="note" role="note"><span class="marker">Note:</span> The contents of each <a data-link-type="dfn" href="#ip-address-space" id="ref-for-ip-address-space⑥">IP address space</a> were at one point determined
  in accordance with the IANA Special-Purpose Address Registries
  (<a data-link-type="biblio" href="#biblio-ipv4-registry" title="IANA IPv4 Special-Purpose Address Registry">[IPV4-REGISTRY]</a> and <a data-link-type="biblio" href="#biblio-ipv6-registry" title="IANA IPv6 Special-Purpose Address Registry">[IPV6-REGISTRY]</a>) and the <code>Globally Reachable</code> bit
  defined therein. This turned out to be an inaccurate signal for our uses, as
  described in <a href="https://github.com/WICG/private-network-access/issues/50">spec issue #50</a>.</p>
    <p class="issue" id="issue-1456f875"><a class="self-link" href="#issue-1456f875"></a> Remove the special case for IPv4-mapped IPv6 addresses once access
  to these addresses is blocked entirely. <a href="https://github.com/wicg/private-network-access/issues/36">[Issue #36]</a></p>
    <h3 class="heading settled" data-level="2.2" id="private-network-request-heading"><span class="secno">2.2. </span><span class="content">Private Network Request</span><a class="self-link" href="#private-network-request-heading"></a></h3>
    <p>A <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#fetch-params-request" id="ref-for-fetch-params-request">request</a> (<var>request</var>) is a <dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="private-network-request">private network request</dfn> if <var>request</var>’s <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-current-url" id="ref-for-concept-request-current-url">current url</a>'s <code class="idl"><a data-link-type="idl" href="https://url.spec.whatwg.org/#dom-url-host" id="ref-for-dom-url-host">host</a></code> maps to an IP address
  whose <a data-link-type="dfn" href="#ip-address-space" id="ref-for-ip-address-space⑦">IP address space</a> is <a data-link-type="dfn" href="#ip-address-space-less-public" id="ref-for-ip-address-space-less-public">less public</a> than <var>request</var>’s <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-policy-container" id="ref-for-concept-request-policy-container">policy container</a>'s <a data-link-type="dfn" href="#policy-container-ip-address-space" id="ref-for-policy-container-ip-address-space">IP address space</a>.</p>
    <p>The classification of IP addresses into three broad <a data-link-type="dfn" href="#ip-address-space" id="ref-for-ip-address-space⑧">address spaces</a> is an
  imperfect and theoretically-unsound approach. It is a proxy used to determine
  whether two network endpoints should be allowed to communicate freely or not,
  in other words whether endpoint A is reachable from endpoint B without
  pivoting through the user agent on endpoint C.</p>
    <p>This approach has some flaws:</p>
    <ul>
     <li data-md>
      <p>false positives: an intranet server with a <a data-link-type="dfn" href="#public-address" id="ref-for-public-address③">public address</a> might be able
to directy issue requests to another server on the same intranet with a <a data-link-type="dfn" href="#private-address" id="ref-for-private-address①">private address</a>.</p>
     <li data-md>
      <p>false negatives: a client connected to two different <a data-link-type="dfn" href="#ip-address-space-private" id="ref-for-ip-address-space-private①④">private</a> networks, say a home network and a VPN, might
allow a website served from the VPN to access devices on the home network.
See also the issue below.</p>
    </ul>
    <p>Even so, this specification aims to offer a pragmatic solution to a security
  issue that broadly affects most users of the Web whose network configurations
  are not so complex.</p>
    <p class="issue" id="issue-4c14e63e"><a class="self-link" href="#issue-4c14e63e"></a> The definition of <a data-link-type="dfn" href="#private-network-request" id="ref-for-private-network-request">private network requests</a> could be expanded to
  cover all cross-origin requests for which the <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-current-url" id="ref-for-concept-request-current-url①">current url</a>'s <code class="idl"><a data-link-type="idl" href="https://url.spec.whatwg.org/#dom-url-host" id="ref-for-dom-url-host①">host</a></code> maps to an IP address whose <a data-link-type="dfn" href="#ip-address-space" id="ref-for-ip-address-space⑨">IP address space</a> is not <a data-link-type="dfn" href="#ip-address-space-public" id="ref-for-ip-address-space-public⑥">public</a>. This would prevent a malicious server on the
  private network from attacking other servers. The effort require to ship such
  a change is not deemed worth the payoff for now. This can be shipped as an
  incremental improvement later on. <a href="https://github.com/wicg/private-network-access/issues/39">[Issue #39]</a></p>
    <p class="note" role="note"><span class="marker">NOTE:</span> Some <a data-link-type="dfn" href="https://wicg.github.io/local-network-access/#local-network-request" id="ref-for-local-network-request">local network requests</a> are more challenging to secure than
  others. See <a href="#rollout-difficulties">§ 4.4 Rollout difficulties</a> for more details.</p>
    <h3 class="heading settled" data-level="2.3" id="headers"><span class="secno">2.3. </span><span class="content">Additional CORS Headers</span><a class="self-link" href="#headers"></a></h3>
    <p>The <dfn class="dfn-paneled" data-dfn-type="http-header" data-export id="http-headerdef-access-control-request-private-network"><code>Access-Control-Request-Private-Network</code></dfn> indicates that the <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#fetch-params-request" id="ref-for-fetch-params-request①">request</a> is a <a data-link-type="dfn" href="#private-network-request" id="ref-for-private-network-request①">private network request</a>.</p>
    <p>The <dfn class="dfn-paneled" data-dfn-type="http-header" data-export id="http-headerdef-access-control-allow-private-network"><code>Access-Control-Allow-Private-Network</code></dfn> indicates that a resource can be safely shared with external networks.</p>
    <p class="note" role="note"><span class="marker">Note:</span> These headers were briefly specified as <code>Access-Control-Request-Local-Network</code> and <code>Access-Control-Allow-Local-Network</code>, but this decision was reversed due to
  its compatibility impact. See <a href="https://github.com/WICG/private-network-access/issues/91">issue #91</a> for
  details.</p>
    <h3 class="heading settled" data-level="2.4" id="csp"><span class="secno">2.4. </span><span class="content">The <code>treat-as-public-address</code> Content Security Policy Directive</span><a class="self-link" href="#csp"></a></h3>
    <p>The <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="treat-as-public-address">treat-as-public-address</dfn> directive instructs the user agent to
  treat a document as though it was served from a <a data-link-type="dfn" href="#public-address" id="ref-for-public-address④">public address</a>, even if
  it was actually served from a <a data-link-type="dfn" href="#private-address" id="ref-for-private-address②">private address</a> or a <a data-link-type="dfn" href="#local-address" id="ref-for-local-address">local address</a>. That
  is, it is a mechanism by which non-public documents may drop the privilege to
  contact other non-public documents without a preflight.</p>
    <p>The directive’s syntax is described by the following ABNF grammar:</p>
<pre>directive-name  = "treat-as-public-address"
directive-value = ""
</pre>
    <p>This directive has no reporting requirements; it will be ignored entirely when
  delivered in a <code>Content-Security-Policy-Report-Only</code> header, or within
  a <code><a data-link-type="element" href="https://html.spec.whatwg.org/multipage/semantics.html#meta" id="ref-for-meta">meta</a></code> element.</p>
    <p>This directive’s <a data-link-type="dfn" href="https://w3c.github.io/webappsec-csp/#directive-initialization" id="ref-for-directive-initialization">initialization</a> algorithm is as follows. Given
  an <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object" id="ref-for-environment-settings-object">environment settings object</a> (<var>context</var>), a <code>Response</code> (<var>response</var>), and
  a <code>policy</code> (<var>policy</var>):</p>
    <ol>
     <li data-md>
      <p>Set <var>context</var>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-policy-container" id="ref-for-concept-settings-object-policy-container">policy container</a>'s <a data-link-type="dfn" href="#policy-container-ip-address-space" id="ref-for-policy-container-ip-address-space①">IP address space</a> to <a data-link-type="dfn" href="#ip-address-space-public" id="ref-for-ip-address-space-public⑦">public</a> if <var>policy</var>’s <a data-link-type="dfn" href="https://w3c.github.io/webappsec-csp/#policy-disposition" id="ref-for-policy-disposition">disposition</a> is "<code>enforce</code>".</p>
    </ol>
    <h3 class="heading settled" data-level="2.5" id="feature-detect"><span class="secno">2.5. </span><span class="content">Feature Detection</span><a class="self-link" href="#feature-detect"></a></h3>
    <p>A previous version of this specification proposed adding an <code>addressSpace</code> enum property to <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/#document" id="ref-for-document">Document</a></code> and <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/workers.html#workerglobalscope" id="ref-for-workerglobalscope">WorkerGlobalScope</a></code>, but it was removed
  due to fingerprinting concerns (see <a href="https://github.com/WICG/private-network-access/issues/21">issue #21</a>).</p>
    <p>Documents should not behave differently or not based on whether the UA
  implements this specification or not - all documents should assume it does.</p>
   </section>
   <section>
    <h2 class="heading settled" data-level="3" id="integrations"><span class="secno">3. </span><span class="content">Integrations</span><a class="self-link" href="#integrations"></a></h2>
    <p><em>This section is non-normative.</em></p>
    <p>This document proposes a number of modifications to other specifications in
  order to implement the mitigations sketched out in the examples above. These
  integrations are outlined here for clarity, but the external documents are the
  normative references.</p>
    <h3 class="heading settled" data-level="3.1" id="integration-fetch"><span class="secno">3.1. </span><span class="content">Integration with Fetch</span><a class="self-link" href="#integration-fetch"></a></h3>
    <p>This document proposes a few changes to Fetch, with the following implication: <a data-link-type="dfn" href="#private-network-request" id="ref-for-private-network-request②">private network requests</a> are only allowed if their <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-client" id="ref-for-concept-request-client">client</a> is
  a <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#secure-context" id="ref-for-secure-context">secure context</a> <strong>and</strong> a <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#cors-preflight-request" id="ref-for-cors-preflight-request⑤">CORS-preflight request</a> to the target origin
  is successful.</p>
    <p class="note" role="note"><span class="marker">Note:</span> This includes navigations. These can indeed be used to trigger CSRF
  attacks, albeit with less subtlety than with subresource requests.</p>
    <p class="note" role="note"><span class="marker">Note:</span> <a data-link-type="biblio" href="#biblio-fetch" title="Fetch Standard">[FETCH]</a> does not yet integrate the details of DNS resolution into the <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-fetch" id="ref-for-concept-fetch">Fetch</a> algorithm, though it does define an <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-connection-obtain" id="ref-for-concept-connection-obtain">obtain a connection</a> algorithm which is enough for this specification. Private Network Access
  checks are applied to the newly-obtained connection. Given complexities such
  as Happy Eyeballs (<a data-biblio-obsolete data-link-type="biblio" href="#biblio-rfc6555" title="Happy Eyeballs: Success with Dual-Stack Hosts">[RFC6555]</a>, <a data-link-type="biblio" href="#biblio-rfc8305" title="Happy Eyeballs Version 2: Better Connectivity Using Concurrency">[RFC8305]</a>), these checks might pass
  or fail non-deterministically for hosts with multiple IP addresses that
  straddle <a data-link-type="dfn" href="#ip-address-space" id="ref-for-ip-address-space①⓪">IP address space</a> boundaries.</p>
    <h4 class="heading settled" data-level="3.1.1" id="secure-context-restriction"><span class="secno">3.1.1. </span><span class="content">Secure context restriction</span><a class="self-link" href="#secure-context-restriction"></a></h4>
    <p>UAs must not allow <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#secure-context" id="ref-for-secure-context①">non-secure</a> <a data-link-type="dfn" href="#ip-address-space-public" id="ref-for-ip-address-space-public⑧">public</a> contexts to request resources from <a data-link-type="dfn" href="#private-address" id="ref-for-private-address③">private addresses</a>, even if the private server would opt-in to such a
  request via a preflight. Making requests to <a data-link-type="dfn" href="#ip-address-space-private" id="ref-for-ip-address-space-private①⑤">private</a> resources presents risks which are mitigated by ensuring the integrity of the <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-client" id="ref-for-concept-request-client①">client</a> which initiates the request. In particular, network
  attackers should not be able to trivially exploit an endpoint’s consent to a
  non-secure origin.</p>
    <p>To that end:</p>
    <ol>
     <li data-md>
      <p><a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-connection" id="ref-for-concept-connection">Connection</a> objects are given a new <dfn class="dfn-paneled" data-dfn-for="connection" data-dfn-type="dfn" data-export id="connection-ip-address-space">IP address space</dfn> property, initially
  null. This applies to WebSocket connections too.</p>
     <li data-md>
      <p>A new step is added to the <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-connection-obtain" id="ref-for-concept-connection-obtain①">obtain a connection</a> algorithm immediately
  before appending <var>connection</var> to the user agent’s <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-connection-pool" id="ref-for-concept-connection-pool">connection pool</a>:</p>
      <ol>
       <li data-md>
        <p>Set <var>connection</var>’s <a data-link-type="dfn" href="#connection-ip-address-space" id="ref-for-connection-ip-address-space">IP address space</a> to
  the result of running the <a data-link-type="dfn" href="#determine-the-ip-address-space" id="ref-for-determine-the-ip-address-space">determine the IP address space</a> algorithm
  on the IP address of <var>connection</var>’s remote endpoint.</p>
        <p class="issue" id="issue-f99ba27e"><a class="self-link" href="#issue-f99ba27e"></a> The remote endpoint concept is not specified in <a data-link-type="biblio" href="#biblio-fetch" title="Fetch Standard">[FETCH]</a> yet, hence this is still handwaving to some extent. <a href="https://github.com/wicg/private-network-access/issues/33">[Issue #33]</a></p>
      </ol>
     <li data-md>
      <p><a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-response" id="ref-for-concept-response">Response</a> objects are given a new <dfn class="dfn-paneled" data-dfn-for="response" data-dfn-type="dfn" data-export id="response-ip-address-space">IP address space</dfn> property, whose value is
  an <a data-link-type="dfn" href="#ip-address-space" id="ref-for-ip-address-space①①">IP address space</a>, initially null.</p>
     <li data-md>
      <p>Define a new <dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="private-network-access-check">Private Network Access check</dfn> algorithm.
  Given a <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#fetch-params-request" id="ref-for-fetch-params-request②">request</a> <var>request</var> and a <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-connection" id="ref-for-concept-connection①">connection</a> <var>connection</var>:</p>
      <ol>
       <li data-md>
        <p>If <var>request</var>’s <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-origin" id="ref-for-concept-request-origin">origin</a> is a <a data-link-type="dfn" href="https://w3c.github.io/webappsec-secure-contexts/#potentially-trustworthy-origin" id="ref-for-potentially-trustworthy-origin">potentially trustworthy
 origin</a> and <var>request</var>’s <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-current-url" id="ref-for-concept-request-current-url②">current URL</a>’s <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-origin" id="ref-for-concept-request-origin①">origin</a> is <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#same-origin" id="ref-for-same-origin">same origin</a> with <var>request</var>’s <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-origin" id="ref-for-concept-request-origin②">origin</a>, then return
 null.</p>
       <li data-md>
        <p>If <var>request</var>’s <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-client" id="ref-for-concept-request-client②">client</a> is a <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#non-secure-context" id="ref-for-non-secure-context">non-secure context</a>:</p>
        <ol>
         <li data-md>
          <p>Let <var>clientAddressSpace</var> be <var>request</var>’s <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-policy-container" id="ref-for-concept-request-policy-container①">policy container</a>'s <a data-link-type="dfn" href="#policy-container-ip-address-space" id="ref-for-policy-container-ip-address-space②">IP address space</a>.</p>
         <li data-md>
          <p>If <var>connection</var>’s <a data-link-type="dfn" href="#connection-ip-address-space" id="ref-for-connection-ip-address-space①">IP address space</a> is <a data-link-type="dfn" href="#ip-address-space-less-public" id="ref-for-ip-address-space-less-public①">less public</a> than <var>clientAddressSpace</var>, then
  return a <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-network-error" id="ref-for-concept-network-error">network error</a>.</p>
        </ol>
       <li data-md>
        <p>Return null.</p>
      </ol>
     <li data-md>
      <p>The <a data-link-type="abstract-op" href="https://fetch.spec.whatwg.org/#concept-http-network-fetch" id="ref-for-concept-http-network-fetch">HTTP-network fetch</a> algorithm is amended to add 3 new steps right
  after checking that the newly-obtained <var>connection</var> is not
  failure:</p>
      <ol>
       <li data-md>
        <p>Set <var>response</var>’s <a data-link-type="dfn" href="#response-ip-address-space" id="ref-for-response-ip-address-space">IP address space</a> to <var>connection</var>’s <a data-link-type="dfn" href="#connection-ip-address-space" id="ref-for-connection-ip-address-space②">IP address space</a>.</p>
       <li data-md>
        <p>Let <var>privateNetworkAccessCheckResult</var> be the result of running <a data-link-type="dfn" href="#private-network-access-check" id="ref-for-private-network-access-check">Private Network Access check</a> for <var>fetchParams</var>’ <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#fetch-params-request" id="ref-for-fetch-params-request③">request</a> and <var>connection</var>.</p>
       <li data-md>
        <p>If <var>privateNetworkAccessCheckResult</var> is a <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-network-error" id="ref-for-concept-network-error①">network error</a>, return <var>privateNetworkAccessCheckResult</var>.</p>
      </ol>
    </ol>
    <h4 class="heading settled" data-level="3.1.2" id="cors-preflight"><span class="secno">3.1.2. </span><span class="content">CORS preflight</span><a class="self-link" href="#cors-preflight"></a></h4>
    <p>The <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-http-fetch" id="ref-for-concept-http-fetch">HTTP fetch</a> algorithm should be adjusted to ensure that a preflight is
  triggered for all <a data-link-type="dfn" href="#private-network-request" id="ref-for-private-network-request③">private network requests</a> initiated from <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#secure-context" id="ref-for-secure-context②">secure contexts</a>.</p>
    <p>The main issue here is again that the response’s <a data-link-type="dfn" href="#response-ip-address-space" id="ref-for-response-ip-address-space①">IP address space</a> is not known until a connection is obtained in <a data-link-type="abstract-op" href="https://fetch.spec.whatwg.org/#concept-http-network-fetch" id="ref-for-concept-http-network-fetch①">HTTP-network fetch</a>, which is layered under <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#cors-preflight-fetch-0" id="ref-for-cors-preflight-fetch-0">CORS-preflight fetch</a>.
  What follows is a sketch of a potential solution:</p>
    <ol>
     <li data-md>
      <p>Add a new <dfn class="dfn-paneled" data-dfn-for="request" data-dfn-type="dfn" data-export id="request-target-ip-address-space">target IP address space</dfn> property
  to the <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#fetch-params-request" id="ref-for-fetch-params-request④">request</a> struct, initially null.</p>
     <li data-md>
      <p>Amend the <a data-link-type="dfn" href="#private-network-access-check" id="ref-for-private-network-access-check①">Private Network Access check</a> algorithm to handle this new
  property and propagate the <a data-link-type="dfn" href="#ip-address-space" id="ref-for-ip-address-space①②">IP address space</a> of the newly-obtained <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-connection" id="ref-for-concept-connection②">connection</a> to the caller of the <a data-link-type="abstract-op" href="https://fetch.spec.whatwg.org/#concept-http-network-fetch" id="ref-for-concept-http-network-fetch②">HTTP-network fetch</a> algorithm when
  the <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-client" id="ref-for-concept-request-client③">client</a> is a <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#secure-context" id="ref-for-secure-context③">secure context</a>:</p>
      <ol>
       <li data-md>
        <p>If <var>request</var>’s <a data-link-type="dfn" href="#request-target-ip-address-space" id="ref-for-request-target-ip-address-space">target IP address space</a> is not null, then:</p>
        <ol>
         <li data-md>
          <p>If <var>connection</var>’s <a data-link-type="dfn" href="#connection-ip-address-space" id="ref-for-connection-ip-address-space③">IP address space</a> is not equal to
  then <var>request</var>’s <a data-link-type="dfn" href="#request-target-ip-address-space" id="ref-for-request-target-ip-address-space①">target IP address space</a>, then return
  a <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-network-error" id="ref-for-concept-network-error②">network error</a>.</p>
         <li data-md>
          <p>Return null.</p>
        </ol>
       <li data-md>
        <p>Let <var>clientAddressSpace</var> be <var>request</var>’s <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-policy-container" id="ref-for-concept-request-policy-container②">policy container</a>'s <a data-link-type="dfn" href="#policy-container-ip-address-space" id="ref-for-policy-container-ip-address-space③">IP address space</a>.</p>
       <li data-md>
        <p>If <var>response</var>’s <a data-link-type="dfn" href="#response-ip-address-space" id="ref-for-response-ip-address-space②">IP address space</a> is <a data-link-type="dfn" href="#ip-address-space-less-public" id="ref-for-ip-address-space-less-public②">less public</a> than <var>clientAddressSpace</var>, then:</p>
        <ol>
         <li data-md>
          <p>Let <var>error</var> be a <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-network-error" id="ref-for-concept-network-error③">network error</a>.</p>
         <li data-md>
          <p>If <var>request</var>’s <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-client" id="ref-for-concept-request-client④">client</a> is a <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#secure-context" id="ref-for-secure-context④">secure context</a>,
  then set <var>error</var>’s <a data-link-type="dfn" href="#response-ip-address-space" id="ref-for-response-ip-address-space③">IP address space</a> property to <var>response</var>’s <a data-link-type="dfn" href="#response-ip-address-space" id="ref-for-response-ip-address-space④">IP address space</a>.</p>
         <li data-md>
          <p>Return <var>error</var>.</p>
        </ol>
       <li data-md>
        <p>Return null.</p>
      </ol>
     <li data-md>
      <p>Define a new algorithm called <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="http-no-service-worker-fetch">HTTP-no-service-worker fetch</dfn> based on the existing steps in <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-http-fetch" id="ref-for-concept-http-fetch①">HTTP fetch</a> that are run if <var>response</var> is still null after handling the fetch via service workers, and amend
  those slightly as follows:</p>
      <ol>
       <li data-md>
        <p>At the very start:</p>
        <ol>
         <li data-md>
          <p>If <var>request</var>’s <a data-link-type="dfn" href="#request-target-ip-address-space" id="ref-for-request-target-ip-address-space②">target IP address space</a> is not null,
  then set <var>makeCORSPreflight</var> to true.</p>
        </ol>
       <li data-md>
        <p>Immediately after running <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#cors-preflight-fetch-0" id="ref-for-cors-preflight-fetch-0①">CORS-preflight fetch</a>:</p>
        <ol>
         <li data-md>
          <p>If <var>preflightResponse</var> is a <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-network-error" id="ref-for-concept-network-error④">network error</a>:</p>
          <ol>
           <li data-md>
            <p>If <var>preflightResponse</var>’s <a data-link-type="dfn" href="#response-ip-address-space" id="ref-for-response-ip-address-space⑤">IP address space</a> is
  null, return <var>preflightResponse</var>.</p>
           <li data-md>
            <p>Set <var>request</var>’s <a data-link-type="dfn" href="#request-target-ip-address-space" id="ref-for-request-target-ip-address-space③">target IP address space</a> to <var>preflightResponse</var>’s <a data-link-type="dfn" href="#response-ip-address-space" id="ref-for-response-ip-address-space⑥">IP address space</a>.</p>
           <li data-md>
            <p>Return the result of running <a data-link-type="dfn" href="#http-no-service-worker-fetch" id="ref-for-http-no-service-worker-fetch">HTTP-no-service-worker fetch</a> given <var>fetchParams</var>.</p>
          </ol>
        </ol>
       <li data-md>
        <p>Immediately after running <a data-link-type="abstract-op" href="https://fetch.spec.whatwg.org/#concept-http-network-or-cache-fetch" id="ref-for-concept-http-network-or-cache-fetch">HTTP-network-or-cache fetch</a>:</p>
        <ol>
         <li data-md>
          <p>If <var>response</var> is a <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-network-error" id="ref-for-concept-network-error⑤">network error</a> and <var>response</var>’s <a data-link-type="dfn" href="#response-ip-address-space" id="ref-for-response-ip-address-space⑦">IP address space</a> is non-null, then:</p>
          <ol>
           <li data-md>
            <p>Set <var>request</var>’s <a data-link-type="dfn" href="#request-target-ip-address-space" id="ref-for-request-target-ip-address-space④">target IP address space</a> to <var>preflightResponse</var>’s <a data-link-type="dfn" href="#response-ip-address-space" id="ref-for-response-ip-address-space⑧">IP address space</a>.</p>
           <li data-md>
            <p>Return the result of running <a data-link-type="dfn" href="#http-no-service-worker-fetch" id="ref-for-http-no-service-worker-fetch①">HTTP-no-service-worker fetch</a> given <var>fetchParams</var>.</p>
          </ol>
        </ol>
      </ol>
      <p class="note" role="note"><span class="marker">Note:</span> Because <var>request</var>’s <a data-link-type="dfn" href="#request-target-ip-address-space" id="ref-for-request-target-ip-address-space⑤">target IP address space</a> is set to a
  non-null value when recursing, this recursion can go at most 1 level deep.</p>
     <li data-md>
      <p>The <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#cors-preflight-fetch-0" id="ref-for-cors-preflight-fetch-0②">CORS-preflight fetch</a> algorithm is adjusted to handle the
  new headers:</p>
      <ol>
       <li data-md>
        <p>Immediately before running <a data-link-type="abstract-op" href="https://fetch.spec.whatwg.org/#concept-http-network-or-cache-fetch" id="ref-for-concept-http-network-or-cache-fetch①">HTTP-network-or-cache fetch</a>:</p>
        <ol>
         <li data-md>
          <p>If <var>request</var>’s <a data-link-type="dfn" href="#request-target-ip-address-space" id="ref-for-request-target-ip-address-space⑥">target IP address space</a> is not null,
  then:</p>
          <ol>
           <li data-md>
            <p><a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-header-list-set" id="ref-for-concept-header-list-set">Set</a> "<a data-link-type="http-header" href="#http-headerdef-access-control-request-private-network" id="ref-for-http-headerdef-access-control-request-private-network②"><code>Access-Control-Request-Private-Network</code></a>"
  to "<code>true</code>" in <var>preflight</var>’s <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-header-list" id="ref-for-concept-request-header-list">header list</a>.</p>
          </ol>
        </ol>
       <li data-md>
        <p>Immediately after the <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-cors-check" id="ref-for-concept-cors-check">CORS check</a>:</p>
        <ol>
         <li data-md>
          <p>If <var>request</var>’s <a data-link-type="dfn" href="#request-target-ip-address-space" id="ref-for-request-target-ip-address-space⑦">target IP address space</a> is not null,
  then:</p>
          <ol>
           <li data-md>
            <p>Let <var>allow</var> be the result of <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#extract-header-list-values" id="ref-for-extract-header-list-values">extracting header list values</a> given
  "<a data-link-type="http-header" href="#http-headerdef-access-control-allow-private-network" id="ref-for-http-headerdef-access-control-allow-private-network③"><code>Access-Control-Allow-Private-Network</code></a>"
  and <var>response</var>’s <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-response-header-list" id="ref-for-concept-response-header-list">header list</a>.</p>
           <li data-md>
            <p>If <var>allow</var> is not "<code>true</code>", return a <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-network-error" id="ref-for-concept-network-error⑥">network error</a>.</p>
          </ol>
        </ol>
      </ol>
     <li data-md>
      <p>Finally, to mitigate the impact of DNS rebinding attacks (see <a href="#dns-rebinding">§ 5.3 DNS Rebinding</a>), the <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-cache" id="ref-for-concept-cache">CORS-preflight cache</a> is adjusted to take <a data-link-type="dfn" href="#ip-address-space" id="ref-for-ip-address-space①③">IP address space</a> information into account:</p>
      <ol>
       <li data-md>
        <p>A new <dfn class="dfn-paneled" data-dfn-for="cache entry" data-dfn-type="dfn" data-export id="cache-entry-ip-address-space">IP address space</dfn> property
  (null or an <a data-link-type="dfn" href="#ip-address-space" id="ref-for-ip-address-space①④">IP address space</a>) is added to each <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#cache-entry" id="ref-for-cache-entry">cache entry</a>.</p>
       <li data-md>
        <p>This new property is initialized by the <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-cache-create-entry" id="ref-for-concept-cache-create-entry">create a new cache entry</a> algorithm from <var>request</var>’s <a data-link-type="dfn" href="#request-target-ip-address-space" id="ref-for-request-target-ip-address-space⑧">target IP address space</a>.</p>
       <li data-md>
        <p>This new property is checked by the <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-cache-match" id="ref-for-concept-cache-match">cache entry match</a> algorithm:</p>
        <ol>
         <li data-md>
          <p><var>entry</var>’s <a data-link-type="dfn" href="#cache-entry-ip-address-space" id="ref-for-cache-entry-ip-address-space">IP address space</a> is
  equal to <var>request</var>’s <a data-link-type="dfn" href="#request-target-ip-address-space" id="ref-for-request-target-ip-address-space⑨">target IP address space</a>.</p>
        </ol>
      </ol>
    </ol>
    <h4 class="heading settled" data-level="3.1.3" id="forbidden-header-names"><span class="secno">3.1.3. </span><span class="content">Forbidden header names</span><a class="self-link" href="#forbidden-header-names"></a></h4>
    <p>A new entry is added to the list of <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#forbidden-request-header" id="ref-for-forbidden-request-header">forbidden request-header</a> names: <a data-link-type="http-header" href="#http-headerdef-access-control-request-private-network" id="ref-for-http-headerdef-access-control-request-private-network③"><code>Access-Control-Request-Private-Network</code></a>.</p>
    <p>The user agent should have full control over this header, just as it does over
  other CORS headers.</p>
    <h3 class="heading settled" data-level="3.2" id="integration-websockets"><span class="secno">3.2. </span><span class="content">Integration with WebSockets</span><a class="self-link" href="#integration-websockets"></a></h3>
    <p class="issue" id="issue-5a78ae74"><a class="self-link" href="#issue-5a78ae74"></a> Preflight requests should probably be sent ahead of WebSocket
  handshakes, given that WebSocket handshakes have roughly the same capabilities
  as <code>&lt;img></code> tags. This might require no additional work to specify given that
  the <a data-link-type="dfn" href="https://websockets.spec.whatwg.org/#concept-websocket-establish" id="ref-for-concept-websocket-establish">establish a WebSocket connection</a> depends on the <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-fetch" id="ref-for-concept-fetch①">Fetch</a> algorithm. <a href="https://github.com/wicg/private-network-access/issues/14">[Issue #14]</a></p>
    <p>A previous version of this specification proposed simply adding the new
  headers (see <a href="#headers">§ 2.3 Additional CORS Headers</a>) to the WebSocket handshake. This would not be
  sufficient to fully guard against CSRF attacks, however.</p>
    <h3 class="heading settled" data-level="3.3" id="integration-html"><span class="secno">3.3. </span><span class="content">Integration with HTML</span><a class="self-link" href="#integration-html"></a></h3>
    <p>To support the checks in <a data-link-type="biblio" href="#biblio-fetch" title="Fetch Standard">[FETCH]</a>, user agents must remember the source <a data-link-type="dfn" href="#ip-address-space" id="ref-for-ip-address-space①⑤">IP address space</a> of contexts in which network requests are made. To this
  effect, the <a data-link-type="biblio" href="#biblio-html" title="HTML Standard">[HTML]</a> specification is patched as follows:</p>
    <ol>
     <li data-md>
      <p>A new <dfn class="dfn-paneled" data-dfn-for="policy container" data-dfn-type="dfn" data-export id="policy-container-ip-address-space">IP address space</dfn> property
  is added to the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#policy-container" id="ref-for-policy-container">policy container</a> <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#struct" id="ref-for-struct">struct</a>.</p>
      <ol>
       <li data-md>
        <p>It is initially <a data-link-type="dfn" href="#ip-address-space-public" id="ref-for-ip-address-space-public⑨">public</a>.</p>
      </ol>
     <li data-md>
      <p>An additional step is added to the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#clone-a-policy-container" id="ref-for-clone-a-policy-container">clone a policy container</a> algorithm:</p>
      <ol>
       <li data-md>
        <p>Set <var>clone</var>’s <a data-link-type="dfn" href="#policy-container-ip-address-space" id="ref-for-policy-container-ip-address-space④">IP address space</a> to <var>policyContainer</var>’s <a data-link-type="dfn" href="#policy-container-ip-address-space" id="ref-for-policy-container-ip-address-space⑤">IP address space</a>.</p>
      </ol>
     <li data-md>
      <p>An additional step is added to the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#creating-a-policy-container-from-a-fetch-response" id="ref-for-creating-a-policy-container-from-a-fetch-response">create a policy container from a
  fetch response</a> algorithm:</p>
      <ol>
       <li data-md>
        <p>Set <var>result</var>’s <a data-link-type="dfn" href="#policy-container-ip-address-space" id="ref-for-policy-container-ip-address-space⑥">IP address space</a> to <var>response</var>’s <a data-link-type="dfn" href="#response-ip-address-space" id="ref-for-response-ip-address-space⑨">IP address space</a>.</p>
      </ol>
    </ol>
    <div class="example" id="example-a76a6ba6">
     <a class="self-link" href="#example-a76a6ba6"></a> Assuming that <code>example.com</code> resolves to a <a data-link-type="dfn" href="#public-address" id="ref-for-public-address⑤">public address</a> (say, <code>123.123.123.123</code>), then the <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/#document" id="ref-for-document①">Document</a></code> created when navigating to <code>https://example.com/document.html</code> will have its <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/dom.html#concept-document-policy-container" id="ref-for-concept-document-policy-container">policy container</a>'s <a data-link-type="dfn" href="#policy-container-ip-address-space" id="ref-for-policy-container-ip-address-space⑦">IP address space</a> property set to <a data-link-type="dfn" href="#ip-address-space-public" id="ref-for-ip-address-space-public①⓪">public</a>. 
     <p>If this <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/#document" id="ref-for-document②">Document</a></code> then embeds an <code>about:srcdoc</code> iframe, then the child
    frame’s <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/#document" id="ref-for-document③">Document</a></code> will have its <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/dom.html#concept-document-policy-container" id="ref-for-concept-document-policy-container①">policy container</a>'s <a data-link-type="dfn" href="#policy-container-ip-address-space" id="ref-for-policy-container-ip-address-space⑧">IP address space</a> property set to <a data-link-type="dfn" href="#ip-address-space-public" id="ref-for-ip-address-space-public①①">public</a>.</p>
     <p>If, on the other hand, <code>example.com</code> resolved to a <a data-link-type="dfn" href="#local-address" id="ref-for-local-address①">local address</a> (say, <code>127.0.0.1</code>), then the <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/#document" id="ref-for-document④">Document</a></code> created when navigating to <code>https://example.com/document.html</code> will have its <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/dom.html#concept-document-policy-container" id="ref-for-concept-document-policy-container②">policy container</a>'s <a data-link-type="dfn" href="#policy-container-ip-address-space" id="ref-for-policy-container-ip-address-space⑨">IP address space</a> property set to <a data-link-type="dfn" href="#ip-address-space-local" id="ref-for-ip-address-space-local⑥">local</a>.</p>
    </div>
    <h3 class="heading settled" data-level="3.4" id="workers"><span class="secno">3.4. </span><span class="content">Workers</span><a class="self-link" href="#workers"></a></h3>
    <p><em>This section is non-normative.</em></p>
    <p>Given that <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/workers.html#workerglobalscope" id="ref-for-workerglobalscope①">WorkerGlobalScope</a></code> already has a <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/workers.html#concept-workerglobalscope-policy-container" id="ref-for-concept-workerglobalscope-policy-container">policy container</a> field populated using the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#creating-a-policy-container-from-a-fetch-response" id="ref-for-creating-a-policy-container-from-a-fetch-response①">create a
  policy container from a fetch response</a> algorithm, the avove integrations
  with Fetch and HTML apply just as well to worker contexts as to documents.</p>
    <div class="example" id="example-9722f9da">
     <a class="self-link" href="#example-9722f9da"></a> Assuming that <code>example.com</code> resolves to a <a data-link-type="dfn" href="#public-address" id="ref-for-public-address⑥">public address</a> (say, <code>123.123.123.123</code>), then a <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/workers.html#workerglobalscope" id="ref-for-workerglobalscope②">WorkerGlobalScope</a></code> created by fetching a
    script from <code>https://example.com/worker.js</code> will have its <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/workers.html#concept-workerglobalscope-policy-container" id="ref-for-concept-workerglobalscope-policy-container①">policy container</a>'s <a data-link-type="dfn" href="#policy-container-ip-address-space" id="ref-for-policy-container-ip-address-space①⓪">IP address space</a> property set to <a data-link-type="dfn" href="#ip-address-space-public" id="ref-for-ip-address-space-public①②">public</a>. 
     <p>Any fetch <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#fetch-params-request" id="ref-for-fetch-params-request⑤">request</a> initiated by this worker that <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-connection-obtain" id="ref-for-concept-connection-obtain②">obtains a connection</a> to an IP address in the <a data-link-type="dfn" href="#ip-address-space-private" id="ref-for-ip-address-space-private①⑥">private</a> or <a data-link-type="dfn" href="#ip-address-space-local" id="ref-for-ip-address-space-local⑦">local</a> <a data-link-type="dfn" href="#ip-address-space" id="ref-for-ip-address-space①⑥">address spaces</a> would then be a <a data-link-type="dfn" href="#private-network-request" id="ref-for-private-network-request④">private network request</a>.</p>
    </div>
    <p class="issue" id="issue-62b6d083"><a class="self-link" href="#issue-62b6d083"></a> The <a data-link-type="dfn" href="https://w3c.github.io/ServiceWorker/#dfn-service-worker" id="ref-for-dfn-service-worker">Service Worker</a> <a data-link-type="dfn" href="https://w3c.github.io/ServiceWorker/#soft-update" id="ref-for-soft-update">soft update</a> algorithm unfortunately sets a <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-client" id="ref-for-concept-request-client⑤">request client</a> of <code>"null"</code> when <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-fetch" id="ref-for-concept-fetch②">fetching</a> an updated script. This causes all sorts of issues, and
  interferes with the <a data-link-type="dfn" href="#private-network-access-check" id="ref-for-private-network-access-check②">private network access check</a> algorithm laid out above.
  Indeed, there is no <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-client" id="ref-for-concept-request-client⑥">request client</a> from which to copy the <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-policy-container" id="ref-for-concept-request-policy-container③">policy container</a> during <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-fetch" id="ref-for-concept-fetch③">fetch</a>. <a href="https://github.com/wicg/private-network-access/issues/83">[Issue #83]</a></p>
   </section>
   <section>
    <h2 class="heading settled" data-level="4" id="implementation-considerations"><span class="secno">4. </span><span class="content">Implementation Considerations</span><a class="self-link" href="#implementation-considerations"></a></h2>
    <h3 class="heading settled" data-level="4.1" id="file-url"><span class="secno">4.1. </span><span class="content">Where do <code>file</code> URLs fit?</span><a class="self-link" href="#file-url"></a></h3>
    <p>It isn’t entirely clear how <code>file</code> URLs fit into the public/private scheme
  outlined above. It would be nice to prevent folks from harming themselves by
  opening a malicious HTML file locally, on the one hand, but on the other, code
  running locally is somewhat outside of any coherent threat model.</p>
    <p>For the moment, let’s err on the side of treating <code>file</code> URLs as <a data-link-type="dfn" href="#ip-address-space-local" id="ref-for-ip-address-space-local⑧">local</a>, as they seem to be just as much a part of the local
  system as anything else on a loopback address.</p>
    <p class="issue" id="issue-5f05c8e3"><a class="self-link" href="#issue-5f05c8e3"></a> Reevaluate this after implementation experience.</p>
    <h3 class="heading settled" data-level="4.2" id="proxies"><span class="secno">4.2. </span><span class="content">Proxies</span><a class="self-link" href="#proxies"></a></h3>
    <p>In the current implementation of this specification in Chromium, proxies
  influence the <a data-link-type="dfn" href="#ip-address-space" id="ref-for-ip-address-space①⑦">address space</a> of resources they proxy. Specifically,
  resources fetched via proxies are considered to have been fetched from the
  proxy’s IP address itself.</p>
    <div class="example" id="example-25373bd8">
     <a class="self-link" href="#example-25373bd8"></a> If a <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/#document" id="ref-for-document⑤">Document</a></code> served by <code>foo.example</code> on a <a data-link-type="dfn" href="#public-address" id="ref-for-public-address⑦">public address</a> is fetched
    by the user agent via a proxy on a <a data-link-type="dfn" href="#private-address" id="ref-for-private-address④">private address</a>, then the <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/#document" id="ref-for-document⑥">Document</a></code>'s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/dom.html#concept-document-policy-container" id="ref-for-concept-document-policy-container③">policy container</a>'s <a data-link-type="dfn" href="#policy-container-ip-address-space" id="ref-for-policy-container-ip-address-space①①">IP address space</a> is set to <a data-link-type="dfn" href="#ip-address-space-private" id="ref-for-ip-address-space-private①⑦">private</a>. 
     <p>The <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/#document" id="ref-for-document⑦">Document</a></code> will in turn be allowed to make requests to other <a data-link-type="dfn" href="#private-address" id="ref-for-private-address⑤">private addresses</a> accessible to the browser.</p>
    </div>
    <p>This can allow a website to learn that it was proxied by observing that it is
  allowed to make requests to <a data-link-type="dfn" href="#private-address" id="ref-for-private-address⑥">private addresses</a>, which is a privacy
  information leak. While this requires correctly guessing the URL of a resource
  on the private network, a single correct guess is sufficient.</p>
    <p>This is expected to be relatively rare and not warrant more mitigations. After
  all, in the status quo all websites can make requests to all IP addresses with
  no restrictions whatsoever.</p>
    <p>It would be interesting to explore a mechanism by which proxies could tell the
  browser "please treat this resource as public/private anyway", thereby passing
  on some information about the IP address behing the proxy. This might take the
  form of the <a href="#csp">CSP directive</a> discussed above, with some minor
  modifications.</p>
    <h3 class="heading settled" data-level="4.3" id="http-cache"><span class="secno">4.3. </span><span class="content">HTTP Cache</span><a class="self-link" href="#http-cache"></a></h3>
    <p>The current implementation of this specification in Chromium interacts with
  the HTTP cache in two noteworthy ways, depending on which kind of resource is
  loaded from cache.</p>
    <h4 class="heading settled" data-level="4.3.1" id="http-cache-main-resources"><span class="secno">4.3.1. </span><span class="content">Main resources</span><a class="self-link" href="#http-cache-main-resources"></a></h4>
    <p>A <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-document" id="ref-for-concept-document">document</a> constructed from a cached <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-response" id="ref-for-concept-response①">response</a> remembers the IP address
  whence the <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-response" id="ref-for-concept-response②">response</a> was initially loaded. The <a data-link-type="dfn" href="#ip-address-space" id="ref-for-ip-address-space①⑧">IP address space</a> of the <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-document" id="ref-for-concept-document①">document</a> is derived anew from the IP address.</p>
    <p>In the common case, this entails that the <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-document" id="ref-for-concept-document②">document</a>'s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/dom.html#concept-document-policy-container" id="ref-for-concept-document-policy-container④">policy container</a>'s <a data-link-type="dfn" href="#policy-container-ip-address-space" id="ref-for-policy-container-ip-address-space①②">IP address space</a> is
  restored unmodified. However in the event that the user agent’s configuration
  has changed, the derived <a data-link-type="dfn" href="#ip-address-space" id="ref-for-ip-address-space①⑨">IP address space</a> might be different.</p>
    <div class="example" id="example-e3908999">
     <a class="self-link" href="#example-e3908999"></a> The user agent navigates to <code>http://foo.example/</code>, loads the main resource
    from <code>1.2.3.4</code>, caches it, then sets the resulting <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-document" id="ref-for-concept-document③">document</a>'s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/dom.html#concept-document-policy-container" id="ref-for-concept-document-policy-container⑤">policy container</a>'s <a data-link-type="dfn" href="#policy-container-ip-address-space" id="ref-for-policy-container-ip-address-space①③">IP address space</a> to <a data-link-type="dfn" href="#ip-address-space-public" id="ref-for-ip-address-space-public①③">public</a>. 
     <p>The user agent then restarts, and a new configuration is applied specifying
    that <code>1.2.3.4</code> should be classified as a <a data-link-type="dfn" href="#private-address" id="ref-for-private-address⑦">private address</a> instead.</p>
     <p>The user agent navigates to <code>http://foo.example/</code> once more and loads the
    main resource from the HTTP cache. The resulting <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-document" id="ref-for-concept-document④">document</a>'s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/dom.html#concept-document-policy-container" id="ref-for-concept-document-policy-container⑥">policy container</a>'s <a data-link-type="dfn" href="#policy-container-ip-address-space" id="ref-for-policy-container-ip-address-space①④">IP address space</a> is
    now set to <a data-link-type="dfn" href="#ip-address-space-private" id="ref-for-ip-address-space-private①⑧">private</a>.</p>
    </div>
    <h4 class="heading settled" data-level="4.3.2" id="http-cache-subresources"><span class="secno">4.3.2. </span><span class="content">Subresources</span><a class="self-link" href="#http-cache-subresources"></a></h4>
    <p>Subresources loaded from the HTTP cache are subject to the <a data-link-type="dfn" href="#private-network-access-check" id="ref-for-private-network-access-check③">Private Network Access check</a>. This is not yet reflected in the algoritms
  above, since that check is only applied in <a data-link-type="abstract-op" href="https://fetch.spec.whatwg.org/#concept-http-network-fetch" id="ref-for-concept-http-network-fetch③">HTTP-network fetch</a>.</p>
    <p class="issue" id="issue-e91d422c"><a class="self-link" href="#issue-e91d422c"></a> Specify and explain Chromium’s behavior here. <a href="https://github.com/wicg/private-network-access/issues/75">[Issue #75]</a></p>
    <p>See <a href="#http-cache-security">§ 5.6 HTTP cache</a> for a discussion of security implications.</p>
    <h3 class="heading settled" data-level="4.4" id="rollout-difficulties"><span class="secno">4.4. </span><span class="content">Rollout difficulties</span><a class="self-link" href="#rollout-difficulties"></a></h3>
    <p>Private Network Access essentially deprecates direct access to the private
  network in favor of more secure user-agent-mediated alternatives. Web
  deprecations are hard. Chromium has encountered many stumbling blocks on the
  way to shipping parts of this specification.</p>
    <p>In particular, shipping restrictions on fetches from <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#non-secure-context" id="ref-for-non-secure-context①">non-secure contexts</a> in the <a data-link-type="dfn" href="#ip-address-space-private" id="ref-for-ip-address-space-private①⑨">private</a> <a data-link-type="dfn" href="#ip-address-space" id="ref-for-ip-address-space②⓪">IP address space</a> to the <a data-link-type="dfn" href="#ip-address-space-local" id="ref-for-ip-address-space-local⑨">local</a> <a data-link-type="dfn" href="#ip-address-space" id="ref-for-ip-address-space②①">IP address space</a> has proven particularly
  difficult, for a lower payoff. Indeed, exploiting such fetches requires
  attackers to already have a foothold in the private network, which
  substantially raises attack difficulty. As a result, Chromium exempted these
  fetches from restrictions temporarily, choosing to focus on fetches from the <a data-link-type="dfn" href="#ip-address-space-public" id="ref-for-ip-address-space-public①④">public</a> <a data-link-type="dfn" href="#ip-address-space" id="ref-for-ip-address-space②②">IP address space</a>.</p>
   </section>
   <section>
    <h2 class="heading settled" data-level="5" id="security-and-privacy-considerations"><span class="secno">5. </span><span class="content">Security and Privacy Considerations</span><a class="self-link" href="#security-and-privacy-considerations"></a></h2>
    <h3 class="heading settled" data-level="5.1" id="user-mediation"><span class="secno">5.1. </span><span class="content">User Mediation</span><a class="self-link" href="#user-mediation"></a></h3>
    <p>The proposal in this document only ensures that the device consents to access
  from the public internet. Users agents MAY ensure that the <em>user</em> consents to
  such access as well, as it might be in their interests to deny such access,
  even though the device itself would allow it.</p>
    <p>This mediation could be done via an explicit permission grant, via some sort
  of pairing ceremony a la <a href="https://en.wikipedia.org/wiki/Password-authenticated_key_agreement">PAKE</a>,
  or any other clever interface which the user agent might devise.</p>
    <h3 class="heading settled" data-level="5.2" id="mixed-content"><span class="secno">5.2. </span><span class="content">Mixed Content</span><a class="self-link" href="#mixed-content"></a></h3>
    <p>The CORS restrictions added by the proposal in this document do not obviate
  mixed content checks <a data-link-type="biblio" href="#biblio-mixed-content-2" title="Mixed Content Level 2">[MIXED-CONTENT-2]</a>. Device consent obtained through a
  CORS preflight request is necessary but not sufficient.</p>
    <p class="note" role="note"><span class="marker">Note:</span> <a data-link-type="biblio" href="#biblio-mixed-content-2" title="Mixed Content Level 2">[MIXED-CONTENT-2]</a> does not prevent secure contexts from fetching
  resources from <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin" id="ref-for-concept-origin">origins</a> whose <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-host" id="ref-for-concept-origin-host">host</a> is <code>localhost</code> or an IP
  address in the <code>127.0.0.0/8</code> or <code>::1/128</code> blocks. See also the definition of <a data-link-type="dfn" href="https://w3c.github.io/webappsec-secure-contexts/#potentially-trustworthy-origin" id="ref-for-potentially-trustworthy-origin①">potentially trustworthy origins</a>.</p>
    <p>Developers who wish to fetch <a data-link-type="dfn" href="#ip-address-space-private" id="ref-for-ip-address-space-private②⓪">private</a> or <a data-link-type="dfn" href="#ip-address-space-local" id="ref-for-ip-address-space-local①⓪">local</a> resources (from hosts other than the above
  exceptions) from <a data-link-type="dfn" href="#ip-address-space-public" id="ref-for-ip-address-space-public①⑤">public</a> pages MUST ensure that the
  connection is secure. This might involve a solution along the lines of <a data-link-type="biblio" href="#biblio-plex" title="How Plex is doing HTTPS for all its users">[PLEX]</a>, where Web PKI certificates are issued to user-specific domain names
  that then resolve to private IP addresses which only make sense on the user’s
  private network.</p>
    <p class="issue" id="issue-725df7ad"><a class="self-link" href="#issue-725df7ad"></a> Some consumer routers implement overly-aggressive protections
  against DNS rebinding attacks by simply blocking DNS responses that resolve to
  non-public IP addresses. This presents a stumbling block for solutions like <a data-link-type="biblio" href="#biblio-plex" title="How Plex is doing HTTPS for all its users">[PLEX]</a>. Workarounds are discussed in the linked issue. <a href="https://github.com/wicg/private-network-access/issues/23">[Issue #23]</a></p>
    <p>This problem space has been explored a few times already and seems worth
  revisiting at some point. One could imagine a pairing ceremony such as the one
  hinted at above, or one of the ideas floated in <a data-link-type="biblio" href="#biblio-secure-local-communication" title="Minutes from &apos;Secure communication with local network devices&apos;: TPAC, 2015">[SECURE-LOCAL-COMMUNICATION]</a>.</p>
    <h3 class="heading settled" data-level="5.3" id="dns-rebinding"><span class="secno">5.3. </span><span class="content">DNS Rebinding</span><a class="self-link" href="#dns-rebinding"></a></h3>
    <p>The mitigation described here operates upon the IP address which the user
  agent actually connects to when loading a particular resource. This check
  MUST be performed for each new connection made, as DNS rebinding attacks
  may otherwise trick the user agent into revealing information it shouldn’t.</p>
    <p>The modifications to the <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-cache" id="ref-for-concept-cache①">CORS-preflight cache</a> are intended to mitigate
  this attack vector.</p>
    <h3 class="heading settled" data-level="5.4" id="scope-mitigation"><span class="secno">5.4. </span><span class="content">Scope of Mitigation</span><a class="self-link" href="#scope-mitigation"></a></h3>
    <p>The proposal in this document merely mitigates attacks against private web
  services, it cannot fully solve them. For example, a router’s
  web-based administration interface must be designed and implemented to defend
  against CSRF on its own, and should not rely on a UA that behaves as specified
  in this document. The mitigation this document specifies is necessary given
  the reality of private web service implementation quality today, but vendors
  should not consider themselves absolved of responsibility, even if all UAs
  implement this mitigation.</p>
    <h3 class="heading settled" data-level="5.5" id="cross-network-confusion"><span class="secno">5.5. </span><span class="content">Cross-network confusion</span><a class="self-link" href="#cross-network-confusion"></a></h3>
    <p>Most private networks cannot communicate with each other, yet they are all
  treated by this specification as belonging to the <a data-link-type="dfn" href="#ip-address-space-private" id="ref-for-ip-address-space-private②①">private</a> <a data-link-type="dfn" href="#ip-address-space" id="ref-for-ip-address-space②③">IP address space</a>. Going further, <a data-link-type="dfn" href="#private-address" id="ref-for-private-address⑧">private addresses</a> have meaning only
  on the private network where they are used. The same IP address might refer to
  entirely different devices in two different networks.</p>
    <p>This opens the door to cross-network attacks:</p>
    <ul>
     <li data-md>
      <p>A user connects to two different private networks: a home Wi-Fi network
  and a corporate VPN. Their smart fridge has been hacked. They open their
  smart fridge’s web interface, which then performs CSRF attacks against
  corporate websites accessible via the VPN.</p>
     <li data-md>
      <p>A user connects to a malicious internet cafe Wi-Fi, which requires users
  to keep a captive portal page open. They close their laptop, go home, open
  up their laptop again. The captive portal page (either still open or
  reloaded from cache as the user agent restores its previous state)
  performs CSRF attacks against the user’s home devices.</p>
     <li data-md>
      <p>A user connects to a malicious internet cafe Wi-Fi, whose captive portal
  website caches a malicious script from <code>http://router.example/popular-library.js</code> (the cafe network administrator
  operates a malicious DNS server) with a very long expiry. The user powers
  their computer off, goes home, boots up their computer again and visits
  their router’s administration interface at <code>http://router.example</code>, which
  embeds <code>/popular-library.js</code>. The malicious script is loaded in the
  administration interface’s first-party context.</p>
    </ul>
    <p>None of these attacks are novel - they are just examples of the limitations of
  this specification.</p>
    <p class="issue" id="issue-cf35bfd4"><a class="self-link" href="#issue-cf35bfd4"></a> Potential mitigations would require noticing network changes and
  clearing state specific to the previous network. Doing so in a fully general
  manner is likely to be impossible short of clearing all state. Maybe a
  practical compromise can be reached. <a href="https://github.com/wicg/private-network-access/issues/28">[Issue #28]</a></p>
    <h3 class="heading settled" data-level="5.6" id="http-cache-security"><span class="secno">5.6. </span><span class="content">HTTP cache</span><a class="self-link" href="#http-cache-security"></a></h3>
    <h4 class="heading settled" data-level="5.6.1" id="http-cache-security-subresources"><span class="secno">5.6.1. </span><span class="content">Applying checks to subresources</span><a class="self-link" href="#http-cache-security-subresources"></a></h4>
    <p class="issue" id="issue-dfc740be"><a class="self-link" href="#issue-dfc740be"></a> The following is no longer accurate. Implementation experience
  revealed that integrating with the cache was useful even in protecting
  network resources against CSRF attacks. This section needs to be rewritten. <a href="https://github.com/wicg/private-network-access/issues/75">[Issue #75]</a></p>
    <p>Cached subresources are not currently protected by this specification, even
  though the HTTP cache remembers the source IP address which could be used in
  the <a data-link-type="dfn" href="#private-network-access-check" id="ref-for-private-network-access-check④">Private Network Access check</a> algorithm during <a data-link-type="abstract-op" href="https://fetch.spec.whatwg.org/#concept-http-network-or-cache-fetch" id="ref-for-concept-http-network-or-cache-fetch②">HTTP-network-or-cache fetch</a>.</p>
    <p>While it may be a good idea to fix this apparent discrepancy, it is not
  directly relevant to the main goal of this specification: preventing CSRF
  attacks.</p>
    <p>At most, a malicious public website might be able to determine whether a user
  has visited particular private websites in the past. This attack on the user’s
  privacy is no worse than the status quo.</p>
    <p>In addition, due to HTTP cache partitioning, a subresource can only be loaded
  from cache by malicious attackers who manage to replicate the <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#network-partition-key" id="ref-for-network-partition-key">network partition key</a> of the <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#cache-entry" id="ref-for-cache-entry①">cache entry</a>. One way an attacker could
  achieve this is by manipulating DNS (see also <a href="#dns-rebinding">§ 5.3 DNS Rebinding</a>) in order to
  impersonate the top-level site that initially embedded the cached resource.</p>
    <div class="example" id="example-742338b8">
     <a class="self-link" href="#example-742338b8"></a> The user agent navigates to <code>http://router.example</code>, which is served from <code>192.168.1.1</code>. The website embeds a logo from <code>http://router.example/$BRAND-logo.png</code>, which is cached. 
     <p>A malicious attacker then re-binds <code>router.example</code> to an
    attacker-controlled public IP address, and somehow tricks the user into
    visiting <code>http://router.example</code> again. The malicious website attempts to
    embed the logo, and monitors whether the load is successful. If so, the
    attacker has determined the brand of the user’s router.</p>
    </div>
    <h4 class="heading settled" data-level="5.6.2" id="http-cache-poisoning"><span class="secno">5.6.2. </span><span class="content">HTTP cache poisoning</span><a class="self-link" href="#http-cache-poisoning"></a></h4>
    <p>While this specification aims to protect private network servers from
  receiving requests from public websites, DNS rebinding can be used to carry
  out a similar attack through cache poisoning of unauthenticated resources.</p>
    <p>Attackers masquerading as <code>http://router.com</code> can cache a malicious script at <code>http://router.com/totally-legit.js</code>. Later on, when the user navigates to <code>http://router.com/</code>, the page might request the poisoned script and execute
  attacker code in a <a data-link-type="dfn" href="#ip-address-space-less-public" id="ref-for-ip-address-space-less-public③">less public</a> <a data-link-type="dfn" href="#ip-address-space" id="ref-for-ip-address-space②④">IP address space</a>.</p>
    <p>This attack is partially mitigated by cache partitioning,
  which makes it so that the attacker must navigate a top-level browsing context
  to <code>http://router.com/</code> before caching resources, which lacks subtlety. It is
  also not specific to Private Network Access, rather being a symptom of
  plaintext HTTP’s lack of authentication and integrity protection.</p>
   </section>
   <section>
    <h2 class="heading settled" data-level="6" id="iana-considerations"><span class="secno">6. </span><span class="content">IANA Considerations</span><a class="self-link" href="#iana-considerations"></a></h2>
    <p>The Content Security Policy Directive registry should be updated with the
  following directives and references <a data-link-type="biblio" href="#biblio-rfc7762" title="Initial Assignment for the Content Security Policy Directives Registry">[RFC7762]</a>:</p>
    <dl>
     <dt data-md><a data-link-type="dfn" href="#treat-as-public-address" id="ref-for-treat-as-public-address"><code>treat-as-public-address</code></a>
     <dd data-md>
      <p>This document (see <a href="#csp">§ 2.4 The treat-as-public-address Content Security Policy Directive</a>)</p>
    </dl>
   </section>
   <section>
    <h2 class="heading settled" data-level="7" id="acknowledgements"><span class="secno">7. </span><span class="content">Acknowledgements</span><a class="self-link" href="#acknowledgements"></a></h2>
    <p>Conversations with Ryan Sleevi, Chris Palmer, and Justin Schuh helped flesh
  out the contours of this proposal. Hopefully they won’t hate it too much.
  Mathias Karlsson has the dubious honor of being the <a href="https://twitter.com/avlidienbrunn/status/680736829679755265">straw
  that broke the camel’s back</a>, and Brian Smith’s contributions to the
  resulting thread were useful, as always.</p>
   </section>
  </main>
<script src="https://www.w3.org/scripts/TR/2021/fixup.js"></script>
  <h2 class="no-num no-ref heading settled" id="index"><span class="content">Index</span><a class="self-link" href="#index"></a></h2>
  <h3 class="no-num no-ref heading settled" id="index-defined-here"><span class="content">Terms defined by this specification</span><a class="self-link" href="#index-defined-here"></a></h3>
  <ul class="index">
   <li><a href="#http-headerdef-access-control-allow-private-network">Access-Control-Allow-Private-Network</a><span>, in § 2.3</span>
   <li><a href="#http-headerdef-access-control-request-private-network">Access-Control-Request-Private-Network</a><span>, in § 2.3</span>
   <li><a href="#ip-address-space">address space</a><span>, in § 2.1</span>
   <li><a href="#determine-the-ip-address-space">determine the IP address space</a><span>, in § 2.1</span>
   <li><a href="#http-no-service-worker-fetch">HTTP-no-service-worker fetch</a><span>, in § 3.1.2</span>
   <li>
    IP address space
    <ul>
     <li><a href="#ip-address-space">definition of</a><span>, in § 2.1</span>
     <li><a href="#cache-entry-ip-address-space">dfn for cache entry</a><span>, in § 3.1.2</span>
     <li><a href="#connection-ip-address-space">dfn for connection</a><span>, in § 3.1.1</span>
     <li><a href="#policy-container-ip-address-space">dfn for policy container</a><span>, in § 3.3</span>
     <li><a href="#response-ip-address-space">dfn for response</a><span>, in § 3.1.1</span>
    </ul>
   <li><a href="#ip-address-space-less-public">less public</a><span>, in § 2.1</span>
   <li><a href="#ip-address-space-local">local</a><span>, in § 2.1</span>
   <li><a href="#local-address">local address</a><span>, in § 2.1</span>
   <li><a href="#ip-address-space-private">private</a><span>, in § 2.1</span>
   <li><a href="#private-address">private address</a><span>, in § 2.1</span>
   <li><a href="#private-network-access-check">Private Network Access check</a><span>, in § 3.1.1</span>
   <li><a href="#private-network-request">private network request</a><span>, in § 2.2</span>
   <li><a href="#ip-address-space-public">public</a><span>, in § 2.1</span>
   <li><a href="#public-address">public address</a><span>, in § 2.1</span>
   <li><a href="#request-target-ip-address-space">target IP address space</a><span>, in § 3.1.2</span>
   <li><a href="#treat-as-public-address">treat-as-public-address</a><span>, in § 2.4</span>
  </ul>
  <h3 class="no-num no-ref heading settled" id="index-defined-elsewhere"><span class="content">Terms defined by reference</span><a class="self-link" href="#index-defined-elsewhere"></a></h3>
  <ul class="index">
   <li>
    <a data-link-type="biblio">[CSP3]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="4582ec82">disposition</span>
     <li><span class="dfn-paneled" id="2e14a243">initialization</span>
    </ul>
   <li>
    <a data-link-type="biblio">[DOM]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="a973e0fe">document</span>
    </ul>
   <li>
    <a data-link-type="biblio">[FETCH]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="e2a3d65d">HTTP-network fetch</span>
     <li><span class="dfn-paneled" id="f4cb4c20">HTTP-network-or-cache fetch</span>
     <li><span class="dfn-paneled" id="82748635">access-control-allow-credentials</span>
     <li><span class="dfn-paneled" id="a6a3b229">access-control-allow-methods</span>
     <li><span class="dfn-paneled" id="eed8e0e4">access-control-allow-origin</span>
     <li><span class="dfn-paneled" id="8db43a5c">access-control-request-method</span>
     <li><span class="dfn-paneled" id="dbbacb0c">cache entry</span>
     <li><span class="dfn-paneled" id="a4ff76ba">cache entry match</span>
     <li><span class="dfn-paneled" id="857d5516">client</span>
     <li><span class="dfn-paneled" id="697965b2">connection</span>
     <li><span class="dfn-paneled" id="f9649676">connection pool</span>
     <li><span class="dfn-paneled" id="fdb35d97">cors check</span>
     <li><span class="dfn-paneled" id="e119682f">cors-preflight cache</span>
     <li><span class="dfn-paneled" id="0105c79c">cors-preflight fetch</span>
     <li><span class="dfn-paneled" id="4d7b724c">cors-preflight request</span>
     <li><span class="dfn-paneled" id="98f9d698">cors-safelisted method</span>
     <li><span class="dfn-paneled" id="99f492fd">cors-safelisted request-header</span>
     <li><span class="dfn-paneled" id="585e7a08">create a new cache entry</span>
     <li><span class="dfn-paneled" id="3f2ca4de">current url</span>
     <li><span class="dfn-paneled" id="3be1d4ac">extracting header list values</span>
     <li><span class="dfn-paneled" id="a33db89a">fetch</span>
     <li><span class="dfn-paneled" id="ad6ec3ab">forbidden request-header</span>
     <li><span class="dfn-paneled" id="6ee0eab1">header list <small>(for request)</small></span>
     <li><span class="dfn-paneled" id="f7b00a8b">header list <small>(for response)</small></span>
     <li><span class="dfn-paneled" id="2aaa2f42">http fetch</span>
     <li><span class="dfn-paneled" id="eb1b1af3">network error</span>
     <li><span class="dfn-paneled" id="7cf440ca">network partition key</span>
     <li><span class="dfn-paneled" id="8e1fb11c">obtain a connection</span>
     <li><span class="dfn-paneled" id="f78d5b5c">origin</span>
     <li><span class="dfn-paneled" id="86efadaf">policy container</span>
     <li><span class="dfn-paneled" id="5695c146">request</span>
     <li><span class="dfn-paneled" id="ee7bba09">response</span>
     <li><span class="dfn-paneled" id="d9f4dab1">set</span>
    </ul>
   <li>
    <a data-link-type="biblio">[HTML]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="07cd5a09">Document</span>
     <li><span class="dfn-paneled" id="83c59a3a">WorkerGlobalScope</span>
     <li><span class="dfn-paneled" id="00c57527">clone a policy container</span>
     <li><span class="dfn-paneled" id="cfb6031b">creating a policy container from a fetch response</span>
     <li><span class="dfn-paneled" id="3e12e042">environment settings object</span>
     <li><span class="dfn-paneled" id="77a2ee6e">host</span>
     <li><span class="dfn-paneled" id="64b89595">meta</span>
     <li><span class="dfn-paneled" id="5155c2d3">non-secure context</span>
     <li><span class="dfn-paneled" id="086e3aff">origin</span>
     <li><span class="dfn-paneled" id="b33787b2">policy container</span>
     <li><span class="dfn-paneled" id="08639fbc">policy container <small>(for Document)</small></span>
     <li><span class="dfn-paneled" id="432147ee">policy container <small>(for WorkerGlobalScope)</small></span>
     <li><span class="dfn-paneled" id="bd1db03d">policy container <small>(for environment settings object)</small></span>
     <li><span class="dfn-paneled" id="7393da89">same origin</span>
     <li><span class="dfn-paneled" id="65181da8">secure context</span>
    </ul>
   <li>
    <a data-link-type="biblio">[INFRA]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="984221ca">struct</span>
    </ul>
   <li>
    <a data-link-type="biblio">[LOCAL-NETWORK-ACCESS]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="4eec4201">local network request</span>
    </ul>
   <li>
    <a data-link-type="biblio">[SECURE-CONTEXTS]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="96dabee7">potentially trustworthy origin</span>
    </ul>
   <li>
    <a data-link-type="biblio">[SERVICE-WORKERS]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="c60ed63a">service worker</span>
     <li><span class="dfn-paneled" id="8dbcc37d">soft update</span>
    </ul>
   <li>
    <a data-link-type="biblio">[URL]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="5718c334">host</span>
    </ul>
   <li>
    <a data-link-type="biblio">[WEBSOCKETS]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="22b84272">establish a websocket connection</span>
    </ul>
  </ul>
  <h2 class="no-num no-ref heading settled" id="references"><span class="content">References</span><a class="self-link" href="#references"></a></h2>
  <h3 class="no-num no-ref heading settled" id="normative"><span class="content">Normative References</span><a class="self-link" href="#normative"></a></h3>
  <dl>
   <dt id="biblio-csp3">[CSP3]
   <dd>Mike West; Antonio Sartori. <a href="https://w3c.github.io/webappsec-csp/"><cite>Content Security Policy Level 3</cite></a>. URL: <a href="https://w3c.github.io/webappsec-csp/">https://w3c.github.io/webappsec-csp/</a>
   <dt id="biblio-dom">[DOM]
   <dd>Anne van Kesteren. <a href="https://dom.spec.whatwg.org/"><cite>DOM Standard</cite></a>. Living Standard. URL: <a href="https://dom.spec.whatwg.org/">https://dom.spec.whatwg.org/</a>
   <dt id="biblio-fetch">[FETCH]
   <dd>Anne van Kesteren. <a href="https://fetch.spec.whatwg.org/"><cite>Fetch Standard</cite></a>. Living Standard. URL: <a href="https://fetch.spec.whatwg.org/">https://fetch.spec.whatwg.org/</a>
   <dt id="biblio-html">[HTML]
   <dd>Anne van Kesteren; et al. <a href="https://html.spec.whatwg.org/multipage/"><cite>HTML Standard</cite></a>. Living Standard. URL: <a href="https://html.spec.whatwg.org/multipage/">https://html.spec.whatwg.org/multipage/</a>
   <dt id="biblio-infra">[INFRA]
   <dd>Anne van Kesteren; Domenic Denicola. <a href="https://infra.spec.whatwg.org/"><cite>Infra Standard</cite></a>. Living Standard. URL: <a href="https://infra.spec.whatwg.org/">https://infra.spec.whatwg.org/</a>
   <dt id="biblio-rfc7762">[RFC7762]
   <dd>M. West. <a href="https://www.rfc-editor.org/rfc/rfc7762"><cite>Initial Assignment for the Content Security Policy Directives Registry</cite></a>. January 2016. Informational. URL: <a href="https://www.rfc-editor.org/rfc/rfc7762">https://www.rfc-editor.org/rfc/rfc7762</a>
   <dt id="biblio-secure-contexts">[SECURE-CONTEXTS]
   <dd>Mike West. <a href="https://w3c.github.io/webappsec-secure-contexts/"><cite>Secure Contexts</cite></a>. URL: <a href="https://w3c.github.io/webappsec-secure-contexts/">https://w3c.github.io/webappsec-secure-contexts/</a>
   <dt id="biblio-service-workers">[SERVICE-WORKERS]
   <dd>Jake Archibald; Marijn Kruisselbrink. <a href="https://w3c.github.io/ServiceWorker/"><cite>Service Workers</cite></a>. URL: <a href="https://w3c.github.io/ServiceWorker/">https://w3c.github.io/ServiceWorker/</a>
   <dt id="biblio-url">[URL]
   <dd>Anne van Kesteren. <a href="https://url.spec.whatwg.org/"><cite>URL Standard</cite></a>. Living Standard. URL: <a href="https://url.spec.whatwg.org/">https://url.spec.whatwg.org/</a>
   <dt id="biblio-websockets">[WEBSOCKETS]
   <dd>Adam Rice. <a href="https://websockets.spec.whatwg.org/"><cite>WebSockets Standard</cite></a>. Living Standard. URL: <a href="https://websockets.spec.whatwg.org/">https://websockets.spec.whatwg.org/</a>
  </dl>
  <h3 class="no-num no-ref heading settled" id="informative"><span class="content">Informative References</span><a class="self-link" href="#informative"></a></h3>
  <dl>
   <dt id="biblio-avastium">[AVASTIUM]
   <dd><a href="https://code.google.com/p/google-security-research/issues/detail?id=679"><cite>Avast: A web-accessible RPC endpoint can launch 'SafeZone' (also called Avastium), a Chromium fork with critical security checks removed.</cite></a>. URL: <a href="https://code.google.com/p/google-security-research/issues/detail?id=679">https://code.google.com/p/google-security-research/issues/detail?id=679</a>
   <dt id="biblio-csrf-exploit-kit">[CSRF-EXPLOIT-KIT]
   <dd>Kafeine. <a href="http://malware.dontneedcoffee.com/2015/05/an-exploit-kit-dedicated-to-csrf.html"><cite>An Exploit Kit dedicated to CSRF Pharming</cite></a>. URL: <a href="http://malware.dontneedcoffee.com/2015/05/an-exploit-kit-dedicated-to-csrf.html">http://malware.dontneedcoffee.com/2015/05/an-exploit-kit-dedicated-to-csrf.html</a>
   <dt id="biblio-drive-by-pharming">[DRIVE-BY-PHARMING]
   <dd>Sid Stamm; Zulfikar Ramzan; Markus Jakobsson. <a href="https://link.springer.com/chapter/10.1007/978-3-540-77048-0_38"><cite>Drive-By Pharming</cite></a>. URL: <a href="https://link.springer.com/chapter/10.1007/978-3-540-77048-0_38">https://link.springer.com/chapter/10.1007/978-3-540-77048-0_38</a>
   <dt id="biblio-ipv4-registry">[IPV4-REGISTRY]
   <dd><a href="https://www.iana.org/assignments/iana-ipv4-special-registry/iana-ipv4-special-registry.xhtml"><cite>IANA IPv4 Special-Purpose Address Registry</cite></a>. URL: <a href="https://www.iana.org/assignments/iana-ipv4-special-registry/iana-ipv4-special-registry.xhtml">https://www.iana.org/assignments/iana-ipv4-special-registry/iana-ipv4-special-registry.xhtml</a>
   <dt id="biblio-ipv6-registry">[IPV6-REGISTRY]
   <dd><a href="https://www.iana.org/assignments/iana-ipv6-special-registry/iana-ipv6-special-registry.xhtml"><cite>IANA IPv6 Special-Purpose Address Registry</cite></a>. URL: <a href="https://www.iana.org/assignments/iana-ipv6-special-registry/iana-ipv6-special-registry.xhtml">https://www.iana.org/assignments/iana-ipv6-special-registry/iana-ipv6-special-registry.xhtml</a>
   <dt id="biblio-link-local-uri">[LINK-LOCAL-URI]
   <dd>B. Carpenter; S. Cheshire; R. Hinden. <a href="https://www.ietf.org/archive/id/draft-ietf-6man-rfc6874bis-07.html"><cite>Representing IPv6 Zone Identifiers in Address Literals and Uniform Resource Identifiers</cite></a>. 12 April 2023. Internet-Draft. URL: <a href="https://www.ietf.org/archive/id/draft-ietf-6man-rfc6874bis-07.html">https://www.ietf.org/archive/id/draft-ietf-6man-rfc6874bis-07.html</a>
   <dt id="biblio-local-network-access">[LOCAL-NETWORK-ACCESS]
   <dd>Local Network Access URL: <a href="https://wicg.github.io/local-network-access/">https://wicg.github.io/local-network-access/</a>
   <dt id="biblio-mixed-content-2">[MIXED-CONTENT-2]
   <dd>Emily Stark; Mike West; Carlos Ibarra Lopez. <a href="https://w3c.github.io/webappsec-mixed-content/level2.html"><cite>Mixed Content Level 2</cite></a>. 14 October 2020. W3C First Public Working Draft. URL: <a href="https://w3c.github.io/webappsec-mixed-content/level2.html">https://w3c.github.io/webappsec-mixed-content/level2.html</a>
   <dt id="biblio-plex">[PLEX]
   <dd>Filippo Valsorda. <a href="https://blog.filippo.io/how-plex-is-doing-https-for-all-its-users/"><cite>How Plex is doing HTTPS for all its users</cite></a>. URL: <a href="https://blog.filippo.io/how-plex-is-doing-https-for-all-its-users/">https://blog.filippo.io/how-plex-is-doing-https-for-all-its-users/</a>
   <dt id="biblio-rfc1122">[RFC1122]
   <dd>R. Braden, Ed.. <a href="https://www.rfc-editor.org/rfc/rfc1122"><cite>Requirements for Internet Hosts - Communication Layers</cite></a>. October 1989. Internet Standard. URL: <a href="https://www.rfc-editor.org/rfc/rfc1122">https://www.rfc-editor.org/rfc/rfc1122</a>
   <dt id="biblio-rfc1918">[RFC1918]
   <dd>Y. Rekhter; et al. <a href="https://www.rfc-editor.org/rfc/rfc1918"><cite>Address Allocation for Private Internets</cite></a>. February 1996. Best Current Practice. URL: <a href="https://www.rfc-editor.org/rfc/rfc1918">https://www.rfc-editor.org/rfc/rfc1918</a>
   <dt id="biblio-rfc2544">[RFC2544]
   <dd>S. Bradner; J. McQuaid. <a href="https://www.rfc-editor.org/rfc/rfc2544"><cite>Benchmarking Methodology for Network Interconnect Devices</cite></a>. March 1999. Informational. URL: <a href="https://www.rfc-editor.org/rfc/rfc2544">https://www.rfc-editor.org/rfc/rfc2544</a>
   <dt id="biblio-rfc3927">[RFC3927]
   <dd>S. Cheshire; B. Aboba; E. Guttman. <a href="https://www.rfc-editor.org/rfc/rfc3927"><cite>Dynamic Configuration of IPv4 Link-Local Addresses</cite></a>. May 2005. Proposed Standard. URL: <a href="https://www.rfc-editor.org/rfc/rfc3927">https://www.rfc-editor.org/rfc/rfc3927</a>
   <dt id="biblio-rfc4193">[RFC4193]
   <dd>R. Hinden; B. Haberman. <a href="https://www.rfc-editor.org/rfc/rfc4193"><cite>Unique Local IPv6 Unicast Addresses</cite></a>. October 2005. Proposed Standard. URL: <a href="https://www.rfc-editor.org/rfc/rfc4193">https://www.rfc-editor.org/rfc/rfc4193</a>
   <dt id="biblio-rfc4291">[RFC4291]
   <dd>R. Hinden; S. Deering. <a href="https://www.rfc-editor.org/rfc/rfc4291"><cite>IP Version 6 Addressing Architecture</cite></a>. February 2006. Draft Standard. URL: <a href="https://www.rfc-editor.org/rfc/rfc4291">https://www.rfc-editor.org/rfc/rfc4291</a>
   <dt id="biblio-rfc6555">[RFC6555]
   <dd>D. Wing; A. Yourtchenko. <a href="https://www.rfc-editor.org/rfc/rfc6555"><cite>Happy Eyeballs: Success with Dual-Stack Hosts</cite></a>. April 2012. Proposed Standard. URL: <a href="https://www.rfc-editor.org/rfc/rfc6555">https://www.rfc-editor.org/rfc/rfc6555</a>
   <dt id="biblio-rfc6598">[RFC6598]
   <dd>J. Weil; et al. <a href="https://www.rfc-editor.org/rfc/rfc6598"><cite>IANA-Reserved IPv4 Prefix for Shared Address Space</cite></a>. April 2012. Best Current Practice. URL: <a href="https://www.rfc-editor.org/rfc/rfc6598">https://www.rfc-editor.org/rfc/rfc6598</a>
   <dt id="biblio-rfc6762">[RFC6762]
   <dd>S. Cheshire; M. Krochmal. <a href="https://www.rfc-editor.org/rfc/rfc6762"><cite>Multicast DNS</cite></a>. February 2013. Proposed Standard. URL: <a href="https://www.rfc-editor.org/rfc/rfc6762">https://www.rfc-editor.org/rfc/rfc6762</a>
   <dt id="biblio-rfc8305">[RFC8305]
   <dd>D. Schinazi; T. Pauly. <a href="https://www.rfc-editor.org/rfc/rfc8305"><cite>Happy Eyeballs Version 2: Better Connectivity Using Concurrency</cite></a>. December 2017. Proposed Standard. URL: <a href="https://www.rfc-editor.org/rfc/rfc8305">https://www.rfc-editor.org/rfc/rfc8305</a>
   <dt id="biblio-secure-local-communication">[SECURE-LOCAL-COMMUNICATION]
   <dd><a href="http://www.w3.org/2015/10/28-local-minutes.html"><cite>Minutes from 'Secure communication with local network devices': TPAC, 2015</cite></a>. URL: <a href="http://www.w3.org/2015/10/28-local-minutes.html">http://www.w3.org/2015/10/28-local-minutes.html</a>
   <dt id="biblio-soho-pharming">[SOHO-PHARMING]
   <dd>Team Cymru. <a href="https://331.cybersec.fun/TeamCymruSOHOPharming.pdf"><cite>SOHO Pharming</cite></a>. URL: <a href="https://331.cybersec.fun/TeamCymruSOHOPharming.pdf">https://331.cybersec.fun/TeamCymruSOHOPharming.pdf</a>
   <dt id="biblio-trend-micro">[TREND-MICRO]
   <dd><a href="https://code.google.com/p/google-security-research/issues/detail?id=693"><cite>TrendMicro node.js HTTP server listening on localhost can execute commands</cite></a>. URL: <a href="https://code.google.com/p/google-security-research/issues/detail?id=693">https://code.google.com/p/google-security-research/issues/detail?id=693</a>
  </dl>
  <h2 class="no-num no-ref heading settled" id="issues-index"><span class="content">Issues Index</span><a class="self-link" href="#issues-index"></a></h2>
  <div style="counter-reset:issue">
   <div class="issue"> Remove the special case for IPv4-mapped IPv6 addresses once access
  to these addresses is blocked entirely. <a href="https://github.com/wicg/private-network-access/issues/36">[Issue #36]</a> <a class="issue-return" href="#issue-1456f875" title="Jump to section">↵</a></div>
   <div class="issue"> The definition of <a data-link-type="dfn" href="#private-network-request">private network requests</a> could be expanded to
  cover all cross-origin requests for which the <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-current-url">current url</a>'s <code class="idl"><a data-link-type="idl" href="https://url.spec.whatwg.org/#dom-url-host">host</a></code> maps to an IP address whose <a data-link-type="dfn" href="#ip-address-space">IP address space</a> is not <a data-link-type="dfn" href="#ip-address-space-public">public</a>. This would prevent a malicious server on the
  private network from attacking other servers. The effort require to ship such
  a change is not deemed worth the payoff for now. This can be shipped as an
  incremental improvement later on. <a href="https://github.com/wicg/private-network-access/issues/39">[Issue #39]</a> <a class="issue-return" href="#issue-4c14e63e" title="Jump to section">↵</a></div>
   <div class="issue"> The remote endpoint concept is not specified in <a data-link-type="biblio" href="#biblio-fetch" title="Fetch Standard">[FETCH]</a> yet, hence this is still handwaving to some extent. <a href="https://github.com/wicg/private-network-access/issues/33">[Issue #33]</a> <a class="issue-return" href="#issue-f99ba27e" title="Jump to section">↵</a></div>
   <div class="issue"> Preflight requests should probably be sent ahead of WebSocket
  handshakes, given that WebSocket handshakes have roughly the same capabilities
  as <code>&lt;img></code> tags. This might require no additional work to specify given that
  the <a data-link-type="dfn" href="https://websockets.spec.whatwg.org/#concept-websocket-establish">establish a WebSocket connection</a> depends on the <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-fetch">Fetch</a> algorithm. <a href="https://github.com/wicg/private-network-access/issues/14">[Issue #14]</a> <a class="issue-return" href="#issue-5a78ae74" title="Jump to section">↵</a></div>
   <div class="issue"> The <a data-link-type="dfn" href="https://w3c.github.io/ServiceWorker/#dfn-service-worker">Service Worker</a> <a data-link-type="dfn" href="https://w3c.github.io/ServiceWorker/#soft-update">soft update</a> algorithm unfortunately sets a <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-client">request client</a> of <code>"null"</code> when <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-fetch">fetching</a> an updated script. This causes all sorts of issues, and
  interferes with the <a data-link-type="dfn" href="#private-network-access-check">private network access check</a> algorithm laid out above.
  Indeed, there is no <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-client">request client</a> from which to copy the <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-policy-container">policy container</a> during <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-fetch">fetch</a>. <a href="https://github.com/wicg/private-network-access/issues/83">[Issue #83]</a> <a class="issue-return" href="#issue-62b6d083" title="Jump to section">↵</a></div>
   <div class="issue"> Reevaluate this after implementation experience. <a class="issue-return" href="#issue-5f05c8e3" title="Jump to section">↵</a></div>
   <div class="issue"> Specify and explain Chromium’s behavior here. <a href="https://github.com/wicg/private-network-access/issues/75">[Issue #75]</a> <a class="issue-return" href="#issue-e91d422c" title="Jump to section">↵</a></div>
   <div class="issue"> Some consumer routers implement overly-aggressive protections
  against DNS rebinding attacks by simply blocking DNS responses that resolve to
  non-public IP addresses. This presents a stumbling block for solutions like <a data-link-type="biblio" href="#biblio-plex" title="How Plex is doing HTTPS for all its users">[PLEX]</a>. Workarounds are discussed in the linked issue. <a href="https://github.com/wicg/private-network-access/issues/23">[Issue #23]</a> <a class="issue-return" href="#issue-725df7ad" title="Jump to section">↵</a></div>
   <div class="issue"> Potential mitigations would require noticing network changes and
  clearing state specific to the previous network. Doing so in a fully general
  manner is likely to be impossible short of clearing all state. Maybe a
  practical compromise can be reached. <a href="https://github.com/wicg/private-network-access/issues/28">[Issue #28]</a> <a class="issue-return" href="#issue-cf35bfd4" title="Jump to section">↵</a></div>
   <div class="issue"> The following is no longer accurate. Implementation experience
  revealed that integrating with the cache was useful even in protecting
  network resources against CSRF attacks. This section needs to be rewritten. <a href="https://github.com/wicg/private-network-access/issues/75">[Issue #75]</a> <a class="issue-return" href="#issue-dfc740be" title="Jump to section">↵</a></div>
  </div>
<script>/* Boilerplate: script-dfn-panel */
"use strict";
{
    const dfnsJson = window.dfnsJson || {};

    function genDfnPanel({dfnID, url, dfnText, refSections, external}) {
        return mk.aside({
            class: "dfn-panel",
            id: `infopanel-for-${dfnID}`,
            "data-for": dfnID,
            "aria-labelled-by":`infopaneltitle-for-${dfnID}`,
            },
            mk.span({id:`infopaneltitle-for-${dfnID}`, style:"display:none"},
                `Info about the '${dfnText}' ${external?"external":""} reference.`),
            mk.a({href:url}, url),
            mk.b({}, "Referenced in:"),
            mk.ul({},
                ...refSections.map(section=>
                    mk.li({},
                        ...section.refs.map((ref, refI)=>
                            [
                                mk.a({
                                    href: `#${ref.id}`
                                    },
                                    (refI == 0) ? section.title : `(${refI + 1})`
                                ),
                                " ",
                            ]
                        ),
                    ),
                ),
            ),
        );
    }

    function genAllDfnPanels() {
        for(const panelData of Object.values(window.dfnpanelData)) {
            const dfnID = panelData.dfnID;
            const dfn = document.getElementById(dfnID);
            if(!dfn) {
                console.log(`Can't find dfn#${dfnID}.`, panelData);
            } else {
                const panel = genDfnPanel(panelData);
                append(document.body, panel);
                insertDfnPopupAction(dfn, panel)
            }
        }
    }

    document.addEventListener("DOMContentLoaded", ()=>{
        genAllDfnPanels();

        // Add popup behavior to all dfns to show the corresponding dfn-panel.
        var dfns = queryAll('.dfn-paneled');
        for(let dfn of dfns) { ; }

        document.body.addEventListener("click", (e) => {
            // If not handled already, just hide all dfn panels.
            hideAllDfnPanels();
        });
    })


    function hideAllDfnPanels() {
        // Turn off any currently "on" or "activated" panels.
        queryAll(".dfn-panel.on, .dfn-panel.activated").forEach(el=>hideDfnPanel(el));
    }

    function showDfnPanel(dfnPanel, dfn) {
        hideAllDfnPanels(); // Only display one at this time.
        dfn.setAttribute("aria-expanded", "true");
        dfnPanel.classList.add("on");
        dfnPanel.style.left = "5px";
        dfnPanel.style.top = "0px";
        const panelRect = dfnPanel.getBoundingClientRect();
        const panelWidth = panelRect.right - panelRect.left;
        if (panelRect.right > document.body.scrollWidth) {
            // Panel's overflowing the screen.
            // Just drop it below the dfn and flip it rightward instead.
            // This still wont' fix things if the screen is *really* wide,
            // but fixing that's a lot harder without 'anchor()'.
            dfnPanel.style.top = "1.5em";
            dfnPanel.style.left = "auto";
            dfnPanel.style.right = "0px";
        }
    }

    function pinDfnPanel(dfnPanel) {
        // Switch it to "activated" state, which pins it.
        dfnPanel.classList.add("activated");
        dfnPanel.style.left = null;
        dfnPanel.style.top = null;
    }

    function hideDfnPanel(dfnPanel, dfn) {
        if(!dfn) {
            dfn = document.getElementById(dfnPanel.getAttribute("data-for"));
        }
        dfn.setAttribute("aria-expanded", "false")
        dfnPanel.classList.remove("on");
        dfnPanel.classList.remove("activated");
    }

    function toggleDfnPanel(dfnPanel, dfn) {
        if(dfnPanel.classList.contains("on")) {
            hideDfnPanel(dfnPanel, dfn);
        } else {
            showDfnPanel(dfnPanel, dfn);
        }
    }

    function insertDfnPopupAction(dfn, dfnPanel) {
        // Find dfn panel
        const panelWrapper = document.createElement('span');
        panelWrapper.appendChild(dfnPanel);
        panelWrapper.style.position = "relative";
        panelWrapper.style.height = "0px";
        dfn.insertAdjacentElement("afterend", panelWrapper);
        dfn.setAttribute('role', 'button');
        dfn.setAttribute('aria-expanded', 'false')
        dfn.tabIndex = 0;
        dfn.classList.add('has-dfn-panel');
        dfn.addEventListener('click', (event) => {
            showDfnPanel(dfnPanel, dfn);
            event.stopPropagation();
        });
        dfn.addEventListener('keypress', (event) => {
            const kc = event.keyCode;
            // 32->Space, 13->Enter
            if(kc == 32 || kc == 13) {
                toggleDfnPanel(dfnPanel, dfn);
                event.stopPropagation();
                event.preventDefault();
            }
        });

        dfnPanel.addEventListener('click', (event) => {
            if (event.target.nodeName == 'A') {
                pinDfnPanel(dfnPanel);
            }
            event.stopPropagation();
        });

        dfnPanel.addEventListener('keydown', (event) => {
            if(event.keyCode == 27) { // Escape key
                hideDfnPanel(dfnPanel, dfn);
                event.stopPropagation();
                event.preventDefault();
            }
        })
    }
}
</script>
<script>/* Boilerplate: script-dfn-panel */
"use strict";
{
    const dfnsJson = window.dfnsJson || {};

    function genDfnPanel({dfnID, url, dfnText, refSections, external}) {
        return mk.aside({
            class: "dfn-panel",
            id: `infopanel-for-${dfnID}`,
            "data-for": dfnID,
            "aria-labelled-by":`infopaneltitle-for-${dfnID}`,
            },
            mk.span({id:`infopaneltitle-for-${dfnID}`, style:"display:none"},
                `Info about the '${dfnText}' ${external?"external":""} reference.`),
            mk.a({href:url}, url),
            mk.b({}, "Referenced in:"),
            mk.ul({},
                ...refSections.map(section=>
                    mk.li({},
                        ...section.refs.map((ref, refI)=>
                            [
                                mk.a({
                                    href: `#${ref.id}`
                                    },
                                    (refI == 0) ? section.title : `(${refI + 1})`
                                ),
                                " ",
                            ]
                        ),
                    ),
                ),
            ),
        );
    }

    function genAllDfnPanels() {
        for(const panelData of Object.values(window.dfnpanelData)) {
            const dfnID = panelData.dfnID;
            const dfn = document.getElementById(dfnID);
            if(!dfn) {
                console.log(`Can't find dfn#${dfnID}.`, panelData);
            } else {
                const panel = genDfnPanel(panelData);
                append(document.body, panel);
                insertDfnPopupAction(dfn, panel)
            }
        }
    }

    document.addEventListener("DOMContentLoaded", ()=>{
        genAllDfnPanels();

        // Add popup behavior to all dfns to show the corresponding dfn-panel.
        var dfns = queryAll('.dfn-paneled');
        for(let dfn of dfns) { ; }

        document.body.addEventListener("click", (e) => {
            // If not handled already, just hide all dfn panels.
            hideAllDfnPanels();
        });
    })


    function hideAllDfnPanels() {
        // Turn off any currently "on" or "activated" panels.
        queryAll(".dfn-panel.on, .dfn-panel.activated").forEach(el=>hideDfnPanel(el));
    }

    function showDfnPanel(dfnPanel, dfn) {
        hideAllDfnPanels(); // Only display one at this time.
        dfn.setAttribute("aria-expanded", "true");
        dfnPanel.classList.add("on");
        dfnPanel.style.left = "5px";
        dfnPanel.style.top = "0px";
        const panelRect = dfnPanel.getBoundingClientRect();
        const panelWidth = panelRect.right - panelRect.left;
        if (panelRect.right > document.body.scrollWidth) {
            // Panel's overflowing the screen.
            // Just drop it below the dfn and flip it rightward instead.
            // This still wont' fix things if the screen is *really* wide,
            // but fixing that's a lot harder without 'anchor()'.
            dfnPanel.style.top = "1.5em";
            dfnPanel.style.left = "auto";
            dfnPanel.style.right = "0px";
        }
    }

    function pinDfnPanel(dfnPanel) {
        // Switch it to "activated" state, which pins it.
        dfnPanel.classList.add("activated");
        dfnPanel.style.left = null;
        dfnPanel.style.top = null;
    }

    function hideDfnPanel(dfnPanel, dfn) {
        if(!dfn) {
            dfn = document.getElementById(dfnPanel.getAttribute("data-for"));
        }
        dfn.setAttribute("aria-expanded", "false")
        dfnPanel.classList.remove("on");
        dfnPanel.classList.remove("activated");
    }

    function toggleDfnPanel(dfnPanel, dfn) {
        if(dfnPanel.classList.contains("on")) {
            hideDfnPanel(dfnPanel, dfn);
        } else {
            showDfnPanel(dfnPanel, dfn);
        }
    }

    function insertDfnPopupAction(dfn, dfnPanel) {
        // Find dfn panel
        const panelWrapper = document.createElement('span');
        panelWrapper.appendChild(dfnPanel);
        panelWrapper.style.position = "relative";
        panelWrapper.style.height = "0px";
        dfn.insertAdjacentElement("afterend", panelWrapper);
        dfn.setAttribute('role', 'button');
        dfn.setAttribute('aria-expanded', 'false')
        dfn.tabIndex = 0;
        dfn.classList.add('has-dfn-panel');
        dfn.addEventListener('click', (event) => {
            showDfnPanel(dfnPanel, dfn);
            event.stopPropagation();
        });
        dfn.addEventListener('keypress', (event) => {
            const kc = event.keyCode;
            // 32->Space, 13->Enter
            if(kc == 32 || kc == 13) {
                toggleDfnPanel(dfnPanel, dfn);
                event.stopPropagation();
                event.preventDefault();
            }
        });

        dfnPanel.addEventListener('click', (event) => {
            if (event.target.nodeName == 'A') {
                pinDfnPanel(dfnPanel);
            }
            event.stopPropagation();
        });

        dfnPanel.addEventListener('keydown', (event) => {
            if(event.keyCode == 27) { // Escape key
                hideDfnPanel(dfnPanel, dfn);
                event.stopPropagation();
                event.preventDefault();
            }
        })
    }
}
</script>
<script>/* Boilerplate: script-dfn-panel-json */
window.dfnpanelData = {};
window.dfnpanelData['4582ec82'] = {"dfnID": "4582ec82", "url": "https://w3c.github.io/webappsec-csp/#policy-disposition", "dfnText": "disposition", "refSections": [{"refs": [{"id": "ref-for-policy-disposition"}], "title": "2.4. The treat-as-public-address Content Security Policy Directive"}], "external": true};
window.dfnpanelData['2e14a243'] = {"dfnID": "2e14a243", "url": "https://w3c.github.io/webappsec-csp/#directive-initialization", "dfnText": "initialization", "refSections": [{"refs": [{"id": "ref-for-directive-initialization"}], "title": "2.4. The treat-as-public-address Content Security Policy Directive"}], "external": true};
window.dfnpanelData['a973e0fe'] = {"dfnID": "a973e0fe", "url": "https://dom.spec.whatwg.org/#concept-document", "dfnText": "document", "refSections": [{"refs": [{"id": "ref-for-concept-document"}, {"id": "ref-for-concept-document\u2460"}, {"id": "ref-for-concept-document\u2461"}, {"id": "ref-for-concept-document\u2462"}, {"id": "ref-for-concept-document\u2463"}], "title": "4.3.1. Main resources"}], "external": true};
window.dfnpanelData['e2a3d65d'] = {"dfnID": "e2a3d65d", "url": "https://fetch.spec.whatwg.org/#concept-http-network-fetch", "dfnText": "HTTP-network fetch", "refSections": [{"refs": [{"id": "ref-for-concept-http-network-fetch"}], "title": "3.1.1. Secure context restriction"}, {"refs": [{"id": "ref-for-concept-http-network-fetch\u2460"}, {"id": "ref-for-concept-http-network-fetch\u2461"}], "title": "3.1.2. CORS preflight"}, {"refs": [{"id": "ref-for-concept-http-network-fetch\u2462"}], "title": "4.3.2. Subresources"}], "external": true};
window.dfnpanelData['f4cb4c20'] = {"dfnID": "f4cb4c20", "url": "https://fetch.spec.whatwg.org/#concept-http-network-or-cache-fetch", "dfnText": "HTTP-network-or-cache fetch", "refSections": [{"refs": [{"id": "ref-for-concept-http-network-or-cache-fetch"}, {"id": "ref-for-concept-http-network-or-cache-fetch\u2460"}], "title": "3.1.2. CORS preflight"}, {"refs": [{"id": "ref-for-concept-http-network-or-cache-fetch\u2461"}], "title": "5.6.1. Applying checks to subresources"}], "external": true};
window.dfnpanelData['82748635'] = {"dfnID": "82748635", "url": "https://fetch.spec.whatwg.org/#http-access-control-allow-credentials", "dfnText": "access-control-allow-credentials", "refSections": [{"refs": [{"id": "ref-for-http-access-control-allow-credentials"}], "title": "1.2.2. Opting-In"}, {"refs": [{"id": "ref-for-http-access-control-allow-credentials\u2460"}], "title": "1.2.3. Navigation"}], "external": true};
window.dfnpanelData['a6a3b229'] = {"dfnID": "a6a3b229", "url": "https://fetch.spec.whatwg.org/#http-access-control-allow-methods", "dfnText": "access-control-allow-methods", "refSections": [{"refs": [{"id": "ref-for-http-access-control-allow-methods"}], "title": "1.2.2. Opting-In"}, {"refs": [{"id": "ref-for-http-access-control-allow-methods\u2460"}], "title": "1.2.3. Navigation"}], "external": true};
window.dfnpanelData['eed8e0e4'] = {"dfnID": "eed8e0e4", "url": "https://fetch.spec.whatwg.org/#http-access-control-allow-origin", "dfnText": "access-control-allow-origin", "refSections": [{"refs": [{"id": "ref-for-http-access-control-allow-origin"}], "title": "1.2.2. Opting-In"}, {"refs": [{"id": "ref-for-http-access-control-allow-origin\u2460"}], "title": "1.2.3. Navigation"}], "external": true};
window.dfnpanelData['8db43a5c'] = {"dfnID": "8db43a5c", "url": "https://fetch.spec.whatwg.org/#http-access-control-request-method", "dfnText": "access-control-request-method", "refSections": [{"refs": [{"id": "ref-for-http-access-control-request-method"}], "title": "1.2.1. Secure by Default"}, {"refs": [{"id": "ref-for-http-access-control-request-method\u2460"}], "title": "1.2.3. Navigation"}], "external": true};
window.dfnpanelData['dbbacb0c'] = {"dfnID": "dbbacb0c", "url": "https://fetch.spec.whatwg.org/#cache-entry", "dfnText": "cache entry", "refSections": [{"refs": [{"id": "ref-for-cache-entry"}], "title": "3.1.2. CORS preflight"}, {"refs": [{"id": "ref-for-cache-entry\u2460"}], "title": "5.6.1. Applying checks to subresources"}], "external": true};
window.dfnpanelData['a4ff76ba'] = {"dfnID": "a4ff76ba", "url": "https://fetch.spec.whatwg.org/#concept-cache-match", "dfnText": "cache entry match", "refSections": [{"refs": [{"id": "ref-for-concept-cache-match"}], "title": "3.1.2. CORS preflight"}], "external": true};
window.dfnpanelData['857d5516'] = {"dfnID": "857d5516", "url": "https://fetch.spec.whatwg.org/#concept-request-client", "dfnText": "client", "refSections": [{"refs": [{"id": "ref-for-concept-request-client"}], "title": "3.1. Integration with Fetch"}, {"refs": [{"id": "ref-for-concept-request-client\u2460"}, {"id": "ref-for-concept-request-client\u2461"}], "title": "3.1.1. Secure context restriction"}, {"refs": [{"id": "ref-for-concept-request-client\u2462"}, {"id": "ref-for-concept-request-client\u2463"}], "title": "3.1.2. CORS preflight"}, {"refs": [{"id": "ref-for-concept-request-client\u2464"}, {"id": "ref-for-concept-request-client\u2465"}], "title": "3.4. Workers"}], "external": true};
window.dfnpanelData['697965b2'] = {"dfnID": "697965b2", "url": "https://fetch.spec.whatwg.org/#concept-connection", "dfnText": "connection", "refSections": [{"refs": [{"id": "ref-for-concept-connection"}, {"id": "ref-for-concept-connection\u2460"}], "title": "3.1.1. Secure context restriction"}, {"refs": [{"id": "ref-for-concept-connection\u2461"}], "title": "3.1.2. CORS preflight"}], "external": true};
window.dfnpanelData['f9649676'] = {"dfnID": "f9649676", "url": "https://fetch.spec.whatwg.org/#concept-connection-pool", "dfnText": "connection pool", "refSections": [{"refs": [{"id": "ref-for-concept-connection-pool"}], "title": "3.1.1. Secure context restriction"}], "external": true};
window.dfnpanelData['fdb35d97'] = {"dfnID": "fdb35d97", "url": "https://fetch.spec.whatwg.org/#concept-cors-check", "dfnText": "cors check", "refSections": [{"refs": [{"id": "ref-for-concept-cors-check"}], "title": "3.1.2. CORS preflight"}], "external": true};
window.dfnpanelData['e119682f'] = {"dfnID": "e119682f", "url": "https://fetch.spec.whatwg.org/#concept-cache", "dfnText": "cors-preflight cache", "refSections": [{"refs": [{"id": "ref-for-concept-cache"}], "title": "3.1.2. CORS preflight"}, {"refs": [{"id": "ref-for-concept-cache\u2460"}], "title": "5.3. DNS Rebinding"}], "external": true};
window.dfnpanelData['0105c79c'] = {"dfnID": "0105c79c", "url": "https://fetch.spec.whatwg.org/#cors-preflight-fetch-0", "dfnText": "cors-preflight fetch", "refSections": [{"refs": [{"id": "ref-for-cors-preflight-fetch-0"}, {"id": "ref-for-cors-preflight-fetch-0\u2460"}, {"id": "ref-for-cors-preflight-fetch-0\u2461"}], "title": "3.1.2. CORS preflight"}], "external": true};
window.dfnpanelData['4d7b724c'] = {"dfnID": "4d7b724c", "url": "https://fetch.spec.whatwg.org/#cors-preflight-request", "dfnText": "cors-preflight request", "refSections": [{"refs": [{"id": "ref-for-cors-preflight-request"}, {"id": "ref-for-cors-preflight-request\u2460"}], "title": "1.2.1. Secure by Default"}, {"refs": [{"id": "ref-for-cors-preflight-request\u2461"}, {"id": "ref-for-cors-preflight-request\u2462"}], "title": "1.2.2. Opting-In"}, {"refs": [{"id": "ref-for-cors-preflight-request\u2463"}], "title": "1.2.3. Navigation"}, {"refs": [{"id": "ref-for-cors-preflight-request\u2464"}], "title": "3.1. Integration with Fetch"}], "external": true};
window.dfnpanelData['98f9d698'] = {"dfnID": "98f9d698", "url": "https://fetch.spec.whatwg.org/#cors-safelisted-method", "dfnText": "cors-safelisted method", "refSections": [{"refs": [{"id": "ref-for-cors-safelisted-method"}], "title": "1.1. Goals"}], "external": true};
window.dfnpanelData['99f492fd'] = {"dfnID": "99f492fd", "url": "https://fetch.spec.whatwg.org/#cors-safelisted-request-header", "dfnText": "cors-safelisted request-header", "refSections": [{"refs": [{"id": "ref-for-cors-safelisted-request-header"}], "title": "1.1. Goals"}], "external": true};
window.dfnpanelData['585e7a08'] = {"dfnID": "585e7a08", "url": "https://fetch.spec.whatwg.org/#concept-cache-create-entry", "dfnText": "create a new cache entry", "refSections": [{"refs": [{"id": "ref-for-concept-cache-create-entry"}], "title": "3.1.2. CORS preflight"}], "external": true};
window.dfnpanelData['3f2ca4de'] = {"dfnID": "3f2ca4de", "url": "https://fetch.spec.whatwg.org/#concept-request-current-url", "dfnText": "current url", "refSections": [{"refs": [{"id": "ref-for-concept-request-current-url"}, {"id": "ref-for-concept-request-current-url\u2460"}], "title": "2.2. Private Network Request"}, {"refs": [{"id": "ref-for-concept-request-current-url\u2461"}], "title": "3.1.1. Secure context restriction"}], "external": true};
window.dfnpanelData['3be1d4ac'] = {"dfnID": "3be1d4ac", "url": "https://fetch.spec.whatwg.org/#extract-header-list-values", "dfnText": "extracting header list values", "refSections": [{"refs": [{"id": "ref-for-extract-header-list-values"}], "title": "3.1.2. CORS preflight"}], "external": true};
window.dfnpanelData['a33db89a'] = {"dfnID": "a33db89a", "url": "https://fetch.spec.whatwg.org/#concept-fetch", "dfnText": "fetch", "refSections": [{"refs": [{"id": "ref-for-concept-fetch"}], "title": "3.1. Integration with Fetch"}, {"refs": [{"id": "ref-for-concept-fetch\u2460"}], "title": "3.2. Integration with WebSockets"}, {"refs": [{"id": "ref-for-concept-fetch\u2461"}, {"id": "ref-for-concept-fetch\u2462"}], "title": "3.4. Workers"}], "external": true};
window.dfnpanelData['ad6ec3ab'] = {"dfnID": "ad6ec3ab", "url": "https://fetch.spec.whatwg.org/#forbidden-request-header", "dfnText": "forbidden request-header", "refSections": [{"refs": [{"id": "ref-for-forbidden-request-header"}], "title": "3.1.3. Forbidden header names"}], "external": true};
window.dfnpanelData['6ee0eab1'] = {"dfnID": "6ee0eab1", "url": "https://fetch.spec.whatwg.org/#concept-request-header-list", "dfnText": "header list (for request)", "refSections": [{"refs": [{"id": "ref-for-concept-request-header-list"}], "title": "3.1.2. CORS preflight"}], "external": true};
window.dfnpanelData['f7b00a8b'] = {"dfnID": "f7b00a8b", "url": "https://fetch.spec.whatwg.org/#concept-response-header-list", "dfnText": "header list (for response)", "refSections": [{"refs": [{"id": "ref-for-concept-response-header-list"}], "title": "3.1.2. CORS preflight"}], "external": true};
window.dfnpanelData['2aaa2f42'] = {"dfnID": "2aaa2f42", "url": "https://fetch.spec.whatwg.org/#concept-http-fetch", "dfnText": "http fetch", "refSections": [{"refs": [{"id": "ref-for-concept-http-fetch"}, {"id": "ref-for-concept-http-fetch\u2460"}], "title": "3.1.2. CORS preflight"}], "external": true};
window.dfnpanelData['eb1b1af3'] = {"dfnID": "eb1b1af3", "url": "https://fetch.spec.whatwg.org/#concept-network-error", "dfnText": "network error", "refSections": [{"refs": [{"id": "ref-for-concept-network-error"}, {"id": "ref-for-concept-network-error\u2460"}], "title": "3.1.1. Secure context restriction"}, {"refs": [{"id": "ref-for-concept-network-error\u2461"}, {"id": "ref-for-concept-network-error\u2462"}, {"id": "ref-for-concept-network-error\u2463"}, {"id": "ref-for-concept-network-error\u2464"}, {"id": "ref-for-concept-network-error\u2465"}], "title": "3.1.2. CORS preflight"}], "external": true};
window.dfnpanelData['7cf440ca'] = {"dfnID": "7cf440ca", "url": "https://fetch.spec.whatwg.org/#network-partition-key", "dfnText": "network partition key", "refSections": [{"refs": [{"id": "ref-for-network-partition-key"}], "title": "5.6.1. Applying checks to subresources"}], "external": true};
window.dfnpanelData['8e1fb11c'] = {"dfnID": "8e1fb11c", "url": "https://fetch.spec.whatwg.org/#concept-connection-obtain", "dfnText": "obtain a connection", "refSections": [{"refs": [{"id": "ref-for-concept-connection-obtain"}], "title": "3.1. Integration with Fetch"}, {"refs": [{"id": "ref-for-concept-connection-obtain\u2460"}], "title": "3.1.1. Secure context restriction"}, {"refs": [{"id": "ref-for-concept-connection-obtain\u2461"}], "title": "3.4. Workers"}], "external": true};
window.dfnpanelData['f78d5b5c'] = {"dfnID": "f78d5b5c", "url": "https://fetch.spec.whatwg.org/#concept-request-origin", "dfnText": "origin", "refSections": [{"refs": [{"id": "ref-for-concept-request-origin"}, {"id": "ref-for-concept-request-origin\u2460"}, {"id": "ref-for-concept-request-origin\u2461"}], "title": "3.1.1. Secure context restriction"}], "external": true};
window.dfnpanelData['86efadaf'] = {"dfnID": "86efadaf", "url": "https://fetch.spec.whatwg.org/#concept-request-policy-container", "dfnText": "policy container", "refSections": [{"refs": [{"id": "ref-for-concept-request-policy-container"}], "title": "2.2. Private Network Request"}, {"refs": [{"id": "ref-for-concept-request-policy-container\u2460"}], "title": "3.1.1. Secure context restriction"}, {"refs": [{"id": "ref-for-concept-request-policy-container\u2461"}], "title": "3.1.2. CORS preflight"}, {"refs": [{"id": "ref-for-concept-request-policy-container\u2462"}], "title": "3.4. Workers"}], "external": true};
window.dfnpanelData['5695c146'] = {"dfnID": "5695c146", "url": "https://fetch.spec.whatwg.org/#fetch-params-request", "dfnText": "request", "refSections": [{"refs": [{"id": "ref-for-fetch-params-request"}], "title": "2.2. Private Network Request"}, {"refs": [{"id": "ref-for-fetch-params-request\u2460"}], "title": "2.3. Additional CORS Headers"}, {"refs": [{"id": "ref-for-fetch-params-request\u2461"}, {"id": "ref-for-fetch-params-request\u2462"}], "title": "3.1.1. Secure context restriction"}, {"refs": [{"id": "ref-for-fetch-params-request\u2463"}], "title": "3.1.2. CORS preflight"}, {"refs": [{"id": "ref-for-fetch-params-request\u2464"}], "title": "3.4. Workers"}], "external": true};
window.dfnpanelData['ee7bba09'] = {"dfnID": "ee7bba09", "url": "https://fetch.spec.whatwg.org/#concept-response", "dfnText": "response", "refSections": [{"refs": [{"id": "ref-for-concept-response"}], "title": "3.1.1. Secure context restriction"}, {"refs": [{"id": "ref-for-concept-response\u2460"}, {"id": "ref-for-concept-response\u2461"}], "title": "4.3.1. Main resources"}], "external": true};
window.dfnpanelData['d9f4dab1'] = {"dfnID": "d9f4dab1", "url": "https://fetch.spec.whatwg.org/#concept-header-list-set", "dfnText": "set", "refSections": [{"refs": [{"id": "ref-for-concept-header-list-set"}], "title": "3.1.2. CORS preflight"}], "external": true};
window.dfnpanelData['07cd5a09'] = {"dfnID": "07cd5a09", "url": "https://html.spec.whatwg.org/#document", "dfnText": "Document", "refSections": [{"refs": [{"id": "ref-for-document"}], "title": "2.5. Feature Detection"}, {"refs": [{"id": "ref-for-document\u2460"}, {"id": "ref-for-document\u2461"}, {"id": "ref-for-document\u2462"}, {"id": "ref-for-document\u2463"}], "title": "3.3. Integration with HTML"}, {"refs": [{"id": "ref-for-document\u2464"}, {"id": "ref-for-document\u2465"}, {"id": "ref-for-document\u2466"}], "title": "4.2. Proxies"}], "external": true};
window.dfnpanelData['83c59a3a'] = {"dfnID": "83c59a3a", "url": "https://html.spec.whatwg.org/multipage/workers.html#workerglobalscope", "dfnText": "WorkerGlobalScope", "refSections": [{"refs": [{"id": "ref-for-workerglobalscope"}], "title": "2.5. Feature Detection"}, {"refs": [{"id": "ref-for-workerglobalscope\u2460"}, {"id": "ref-for-workerglobalscope\u2461"}], "title": "3.4. Workers"}], "external": true};
window.dfnpanelData['00c57527'] = {"dfnID": "00c57527", "url": "https://html.spec.whatwg.org/multipage/browsers.html#clone-a-policy-container", "dfnText": "clone a policy container", "refSections": [{"refs": [{"id": "ref-for-clone-a-policy-container"}], "title": "3.3. Integration with HTML"}], "external": true};
window.dfnpanelData['cfb6031b'] = {"dfnID": "cfb6031b", "url": "https://html.spec.whatwg.org/multipage/browsers.html#creating-a-policy-container-from-a-fetch-response", "dfnText": "creating a policy container from a fetch response", "refSections": [{"refs": [{"id": "ref-for-creating-a-policy-container-from-a-fetch-response"}], "title": "3.3. Integration with HTML"}, {"refs": [{"id": "ref-for-creating-a-policy-container-from-a-fetch-response\u2460"}], "title": "3.4. Workers"}], "external": true};
window.dfnpanelData['3e12e042'] = {"dfnID": "3e12e042", "url": "https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object", "dfnText": "environment settings object", "refSections": [{"refs": [{"id": "ref-for-environment-settings-object"}], "title": "2.4. The treat-as-public-address Content Security Policy Directive"}], "external": true};
window.dfnpanelData['77a2ee6e'] = {"dfnID": "77a2ee6e", "url": "https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-host", "dfnText": "host", "refSections": [{"refs": [{"id": "ref-for-concept-origin-host"}], "title": "5.2. Mixed Content"}], "external": true};
window.dfnpanelData['64b89595'] = {"dfnID": "64b89595", "url": "https://html.spec.whatwg.org/multipage/semantics.html#meta", "dfnText": "meta", "refSections": [{"refs": [{"id": "ref-for-meta"}], "title": "2.4. The treat-as-public-address Content Security Policy Directive"}], "external": true};
window.dfnpanelData['5155c2d3'] = {"dfnID": "5155c2d3", "url": "https://html.spec.whatwg.org/multipage/webappapis.html#non-secure-context", "dfnText": "non-secure context", "refSections": [{"refs": [{"id": "ref-for-non-secure-context"}], "title": "3.1.1. Secure context restriction"}, {"refs": [{"id": "ref-for-non-secure-context\u2460"}], "title": "4.4. Rollout difficulties"}], "external": true};
window.dfnpanelData['086e3aff'] = {"dfnID": "086e3aff", "url": "https://html.spec.whatwg.org/multipage/browsers.html#concept-origin", "dfnText": "origin", "refSections": [{"refs": [{"id": "ref-for-concept-origin"}], "title": "5.2. Mixed Content"}], "external": true};
window.dfnpanelData['b33787b2'] = {"dfnID": "b33787b2", "url": "https://html.spec.whatwg.org/multipage/browsers.html#policy-container", "dfnText": "policy container", "refSections": [{"refs": [{"id": "ref-for-policy-container"}], "title": "3.3. Integration with HTML"}], "external": true};
window.dfnpanelData['08639fbc'] = {"dfnID": "08639fbc", "url": "https://html.spec.whatwg.org/multipage/dom.html#concept-document-policy-container", "dfnText": "policy container (for Document)", "refSections": [{"refs": [{"id": "ref-for-concept-document-policy-container"}, {"id": "ref-for-concept-document-policy-container\u2460"}, {"id": "ref-for-concept-document-policy-container\u2461"}], "title": "3.3. Integration with HTML"}, {"refs": [{"id": "ref-for-concept-document-policy-container\u2462"}], "title": "4.2. Proxies"}, {"refs": [{"id": "ref-for-concept-document-policy-container\u2463"}, {"id": "ref-for-concept-document-policy-container\u2464"}, {"id": "ref-for-concept-document-policy-container\u2465"}], "title": "4.3.1. Main resources"}], "external": true};
window.dfnpanelData['432147ee'] = {"dfnID": "432147ee", "url": "https://html.spec.whatwg.org/multipage/workers.html#concept-workerglobalscope-policy-container", "dfnText": "policy container (for WorkerGlobalScope)", "refSections": [{"refs": [{"id": "ref-for-concept-workerglobalscope-policy-container"}, {"id": "ref-for-concept-workerglobalscope-policy-container\u2460"}], "title": "3.4. Workers"}], "external": true};
window.dfnpanelData['bd1db03d'] = {"dfnID": "bd1db03d", "url": "https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-policy-container", "dfnText": "policy container (for environment settings object)", "refSections": [{"refs": [{"id": "ref-for-concept-settings-object-policy-container"}], "title": "2.4. The treat-as-public-address Content Security Policy Directive"}], "external": true};
window.dfnpanelData['7393da89'] = {"dfnID": "7393da89", "url": "https://html.spec.whatwg.org/multipage/browsers.html#same-origin", "dfnText": "same origin", "refSections": [{"refs": [{"id": "ref-for-same-origin"}], "title": "3.1.1. Secure context restriction"}], "external": true};
window.dfnpanelData['65181da8'] = {"dfnID": "65181da8", "url": "https://html.spec.whatwg.org/multipage/webappapis.html#secure-context", "dfnText": "secure context", "refSections": [{"refs": [{"id": "ref-for-secure-context"}], "title": "3.1. Integration with Fetch"}, {"refs": [{"id": "ref-for-secure-context\u2460"}], "title": "3.1.1. Secure context restriction"}, {"refs": [{"id": "ref-for-secure-context\u2461"}, {"id": "ref-for-secure-context\u2462"}, {"id": "ref-for-secure-context\u2463"}], "title": "3.1.2. CORS preflight"}], "external": true};
window.dfnpanelData['984221ca'] = {"dfnID": "984221ca", "url": "https://infra.spec.whatwg.org/#struct", "dfnText": "struct", "refSections": [{"refs": [{"id": "ref-for-struct"}], "title": "3.3. Integration with HTML"}], "external": true};
window.dfnpanelData['4eec4201'] = {"dfnID": "4eec4201", "url": "https://wicg.github.io/local-network-access/#local-network-request", "dfnText": "local network request", "refSections": [{"refs": [{"id": "ref-for-local-network-request"}], "title": "2.2. Private Network Request"}], "external": true};
window.dfnpanelData['96dabee7'] = {"dfnID": "96dabee7", "url": "https://w3c.github.io/webappsec-secure-contexts/#potentially-trustworthy-origin", "dfnText": "potentially trustworthy origin", "refSections": [{"refs": [{"id": "ref-for-potentially-trustworthy-origin"}], "title": "3.1.1. Secure context restriction"}, {"refs": [{"id": "ref-for-potentially-trustworthy-origin\u2460"}], "title": "5.2. Mixed Content"}], "external": true};
window.dfnpanelData['c60ed63a'] = {"dfnID": "c60ed63a", "url": "https://w3c.github.io/ServiceWorker/#dfn-service-worker", "dfnText": "service worker", "refSections": [{"refs": [{"id": "ref-for-dfn-service-worker"}], "title": "3.4. Workers"}], "external": true};
window.dfnpanelData['8dbcc37d'] = {"dfnID": "8dbcc37d", "url": "https://w3c.github.io/ServiceWorker/#soft-update", "dfnText": "soft update", "refSections": [{"refs": [{"id": "ref-for-soft-update"}], "title": "3.4. Workers"}], "external": true};
window.dfnpanelData['5718c334'] = {"dfnID": "5718c334", "url": "https://url.spec.whatwg.org/#dom-url-host", "dfnText": "host", "refSections": [{"refs": [{"id": "ref-for-dom-url-host"}, {"id": "ref-for-dom-url-host\u2460"}], "title": "2.2. Private Network Request"}], "external": true};
window.dfnpanelData['22b84272'] = {"dfnID": "22b84272", "url": "https://websockets.spec.whatwg.org/#concept-websocket-establish", "dfnText": "establish a websocket connection", "refSections": [{"refs": [{"id": "ref-for-concept-websocket-establish"}], "title": "3.2. Integration with WebSockets"}], "external": true};
window.dfnpanelData['ip-address-space'] = {"dfnID": "ip-address-space", "url": "#ip-address-space", "dfnText": "IP address space", "refSections": [{"refs": [{"id": "ref-for-ip-address-space"}, {"id": "ref-for-ip-address-space\u2460"}, {"id": "ref-for-ip-address-space\u2461"}, {"id": "ref-for-ip-address-space\u2462"}, {"id": "ref-for-ip-address-space\u2463"}, {"id": "ref-for-ip-address-space\u2464"}, {"id": "ref-for-ip-address-space\u2465"}], "title": "2.1. IP Address Space"}, {"refs": [{"id": "ref-for-ip-address-space\u2466"}, {"id": "ref-for-ip-address-space\u2467"}, {"id": "ref-for-ip-address-space\u2468"}], "title": "2.2. Private Network Request"}, {"refs": [{"id": "ref-for-ip-address-space\u2460\u24ea"}], "title": "3.1. Integration with Fetch"}, {"refs": [{"id": "ref-for-ip-address-space\u2460\u2460"}], "title": "3.1.1. Secure context restriction"}, {"refs": [{"id": "ref-for-ip-address-space\u2460\u2461"}, {"id": "ref-for-ip-address-space\u2460\u2462"}, {"id": "ref-for-ip-address-space\u2460\u2463"}], "title": "3.1.2. CORS preflight"}, {"refs": [{"id": "ref-for-ip-address-space\u2460\u2464"}], "title": "3.3. Integration with HTML"}, {"refs": [{"id": "ref-for-ip-address-space\u2460\u2465"}], "title": "3.4. Workers"}, {"refs": [{"id": "ref-for-ip-address-space\u2460\u2466"}], "title": "4.2. Proxies"}, {"refs": [{"id": "ref-for-ip-address-space\u2460\u2467"}, {"id": "ref-for-ip-address-space\u2460\u2468"}], "title": "4.3.1. Main resources"}, {"refs": [{"id": "ref-for-ip-address-space\u2461\u24ea"}, {"id": "ref-for-ip-address-space\u2461\u2460"}, {"id": "ref-for-ip-address-space\u2461\u2461"}], "title": "4.4. Rollout difficulties"}, {"refs": [{"id": "ref-for-ip-address-space\u2461\u2462"}], "title": "5.5. Cross-network confusion"}, {"refs": [{"id": "ref-for-ip-address-space\u2461\u2463"}], "title": "5.6.2. HTTP cache poisoning"}], "external": false};
window.dfnpanelData['ip-address-space-local'] = {"dfnID": "ip-address-space-local", "url": "#ip-address-space-local", "dfnText": "local", "refSections": [{"refs": [{"id": "ref-for-ip-address-space-local"}, {"id": "ref-for-ip-address-space-local\u2460"}, {"id": "ref-for-ip-address-space-local\u2461"}, {"id": "ref-for-ip-address-space-local\u2462"}, {"id": "ref-for-ip-address-space-local\u2463"}, {"id": "ref-for-ip-address-space-local\u2464"}], "title": "2.1. IP Address Space"}, {"refs": [{"id": "ref-for-ip-address-space-local\u2465"}], "title": "3.3. Integration with HTML"}, {"refs": [{"id": "ref-for-ip-address-space-local\u2466"}], "title": "3.4. Workers"}, {"refs": [{"id": "ref-for-ip-address-space-local\u2467"}], "title": "4.1. Where do file URLs fit?"}, {"refs": [{"id": "ref-for-ip-address-space-local\u2468"}], "title": "4.4. Rollout difficulties"}, {"refs": [{"id": "ref-for-ip-address-space-local\u2460\u24ea"}], "title": "5.2. Mixed Content"}], "external": false};
window.dfnpanelData['ip-address-space-private'] = {"dfnID": "ip-address-space-private", "url": "#ip-address-space-private", "dfnText": "private", "refSections": [{"refs": [{"id": "ref-for-ip-address-space-private"}], "title": "1.2.1. Secure by Default"}, {"refs": [{"id": "ref-for-ip-address-space-private\u2460"}], "title": "1.2.2. Opting-In"}, {"refs": [{"id": "ref-for-ip-address-space-private\u2461"}, {"id": "ref-for-ip-address-space-private\u2462"}, {"id": "ref-for-ip-address-space-private\u2463"}, {"id": "ref-for-ip-address-space-private\u2464"}, {"id": "ref-for-ip-address-space-private\u2465"}, {"id": "ref-for-ip-address-space-private\u2466"}, {"id": "ref-for-ip-address-space-private\u2467"}, {"id": "ref-for-ip-address-space-private\u2468"}, {"id": "ref-for-ip-address-space-private\u2460\u24ea"}, {"id": "ref-for-ip-address-space-private\u2460\u2460"}, {"id": "ref-for-ip-address-space-private\u2460\u2461"}, {"id": "ref-for-ip-address-space-private\u2460\u2462"}], "title": "2.1. IP Address Space"}, {"refs": [{"id": "ref-for-ip-address-space-private\u2460\u2463"}], "title": "2.2. Private Network Request"}, {"refs": [{"id": "ref-for-ip-address-space-private\u2460\u2464"}], "title": "3.1.1. Secure context restriction"}, {"refs": [{"id": "ref-for-ip-address-space-private\u2460\u2465"}], "title": "3.4. Workers"}, {"refs": [{"id": "ref-for-ip-address-space-private\u2460\u2466"}], "title": "4.2. Proxies"}, {"refs": [{"id": "ref-for-ip-address-space-private\u2460\u2467"}], "title": "4.3.1. Main resources"}, {"refs": [{"id": "ref-for-ip-address-space-private\u2460\u2468"}], "title": "4.4. Rollout difficulties"}, {"refs": [{"id": "ref-for-ip-address-space-private\u2461\u24ea"}], "title": "5.2. Mixed Content"}, {"refs": [{"id": "ref-for-ip-address-space-private\u2461\u2460"}], "title": "5.5. Cross-network confusion"}], "external": false};
window.dfnpanelData['ip-address-space-public'] = {"dfnID": "ip-address-space-public", "url": "#ip-address-space-public", "dfnText": "public", "refSections": [{"refs": [{"id": "ref-for-ip-address-space-public"}], "title": "1.2.2. Opting-In"}, {"refs": [{"id": "ref-for-ip-address-space-public\u2460"}, {"id": "ref-for-ip-address-space-public\u2461"}, {"id": "ref-for-ip-address-space-public\u2462"}, {"id": "ref-for-ip-address-space-public\u2463"}, {"id": "ref-for-ip-address-space-public\u2464"}], "title": "2.1. IP Address Space"}, {"refs": [{"id": "ref-for-ip-address-space-public\u2465"}], "title": "2.2. Private Network Request"}, {"refs": [{"id": "ref-for-ip-address-space-public\u2466"}], "title": "2.4. The treat-as-public-address Content Security Policy Directive"}, {"refs": [{"id": "ref-for-ip-address-space-public\u2467"}], "title": "3.1.1. Secure context restriction"}, {"refs": [{"id": "ref-for-ip-address-space-public\u2468"}, {"id": "ref-for-ip-address-space-public\u2460\u24ea"}, {"id": "ref-for-ip-address-space-public\u2460\u2460"}], "title": "3.3. Integration with HTML"}, {"refs": [{"id": "ref-for-ip-address-space-public\u2460\u2461"}], "title": "3.4. Workers"}, {"refs": [{"id": "ref-for-ip-address-space-public\u2460\u2462"}], "title": "4.3.1. Main resources"}, {"refs": [{"id": "ref-for-ip-address-space-public\u2460\u2463"}], "title": "4.4. Rollout difficulties"}, {"refs": [{"id": "ref-for-ip-address-space-public\u2460\u2464"}], "title": "5.2. Mixed Content"}], "external": false};
window.dfnpanelData['local-address'] = {"dfnID": "local-address", "url": "#local-address", "dfnText": "local address", "refSections": [{"refs": [{"id": "ref-for-local-address"}], "title": "2.4. The treat-as-public-address Content Security Policy Directive"}, {"refs": [{"id": "ref-for-local-address\u2460"}], "title": "3.3. Integration with HTML"}], "external": false};
window.dfnpanelData['private-address'] = {"dfnID": "private-address", "url": "#private-address", "dfnText": "private address", "refSections": [{"refs": [{"id": "ref-for-private-address"}], "title": "1.2.3. Navigation"}, {"refs": [{"id": "ref-for-private-address\u2460"}], "title": "2.2. Private Network Request"}, {"refs": [{"id": "ref-for-private-address\u2461"}], "title": "2.4. The treat-as-public-address Content Security Policy Directive"}, {"refs": [{"id": "ref-for-private-address\u2462"}], "title": "3.1.1. Secure context restriction"}, {"refs": [{"id": "ref-for-private-address\u2463"}, {"id": "ref-for-private-address\u2464"}, {"id": "ref-for-private-address\u2465"}], "title": "4.2. Proxies"}, {"refs": [{"id": "ref-for-private-address\u2466"}], "title": "4.3.1. Main resources"}, {"refs": [{"id": "ref-for-private-address\u2467"}], "title": "5.5. Cross-network confusion"}], "external": false};
window.dfnpanelData['public-address'] = {"dfnID": "public-address", "url": "#public-address", "dfnText": "public address", "refSections": [{"refs": [{"id": "ref-for-public-address"}], "title": "1.2.1. Secure by Default"}, {"refs": [{"id": "ref-for-public-address\u2460"}, {"id": "ref-for-public-address\u2461"}], "title": "1.2.3. Navigation"}, {"refs": [{"id": "ref-for-public-address\u2462"}], "title": "2.2. Private Network Request"}, {"refs": [{"id": "ref-for-public-address\u2463"}], "title": "2.4. The treat-as-public-address Content Security Policy Directive"}, {"refs": [{"id": "ref-for-public-address\u2464"}], "title": "3.3. Integration with HTML"}, {"refs": [{"id": "ref-for-public-address\u2465"}], "title": "3.4. Workers"}, {"refs": [{"id": "ref-for-public-address\u2466"}], "title": "4.2. Proxies"}], "external": false};
window.dfnpanelData['ip-address-space-less-public'] = {"dfnID": "ip-address-space-less-public", "url": "#ip-address-space-less-public", "dfnText": "less public", "refSections": [{"refs": [{"id": "ref-for-ip-address-space-less-public"}], "title": "2.2. Private Network Request"}, {"refs": [{"id": "ref-for-ip-address-space-less-public\u2460"}], "title": "3.1.1. Secure context restriction"}, {"refs": [{"id": "ref-for-ip-address-space-less-public\u2461"}], "title": "3.1.2. CORS preflight"}, {"refs": [{"id": "ref-for-ip-address-space-less-public\u2462"}], "title": "5.6.2. HTTP cache poisoning"}], "external": false};
window.dfnpanelData['determine-the-ip-address-space'] = {"dfnID": "determine-the-ip-address-space", "url": "#determine-the-ip-address-space", "dfnText": "determine the IP address space", "refSections": [{"refs": [{"id": "ref-for-determine-the-ip-address-space"}], "title": "3.1.1. Secure context restriction"}], "external": false};
window.dfnpanelData['private-network-request'] = {"dfnID": "private-network-request", "url": "#private-network-request", "dfnText": "private network request", "refSections": [{"refs": [{"id": "ref-for-private-network-request"}], "title": "2.2. Private Network Request"}, {"refs": [{"id": "ref-for-private-network-request\u2460"}], "title": "2.3. Additional CORS Headers"}, {"refs": [{"id": "ref-for-private-network-request\u2461"}], "title": "3.1. Integration with Fetch"}, {"refs": [{"id": "ref-for-private-network-request\u2462"}], "title": "3.1.2. CORS preflight"}, {"refs": [{"id": "ref-for-private-network-request\u2463"}], "title": "3.4. Workers"}], "external": false};
window.dfnpanelData['http-headerdef-access-control-request-private-network'] = {"dfnID": "http-headerdef-access-control-request-private-network", "url": "#http-headerdef-access-control-request-private-network", "dfnText": "Access-Control-Request-Private-Network", "refSections": [{"refs": [{"id": "ref-for-http-headerdef-access-control-request-private-network"}], "title": "1.2.1. Secure by Default"}, {"refs": [{"id": "ref-for-http-headerdef-access-control-request-private-network\u2460"}], "title": "1.2.3. Navigation"}, {"refs": [{"id": "ref-for-http-headerdef-access-control-request-private-network\u2461"}], "title": "3.1.2. CORS preflight"}, {"refs": [{"id": "ref-for-http-headerdef-access-control-request-private-network\u2462"}], "title": "3.1.3. Forbidden header names"}], "external": false};
window.dfnpanelData['http-headerdef-access-control-allow-private-network'] = {"dfnID": "http-headerdef-access-control-allow-private-network", "url": "#http-headerdef-access-control-allow-private-network", "dfnText": "Access-Control-Allow-Private-Network", "refSections": [{"refs": [{"id": "ref-for-http-headerdef-access-control-allow-private-network"}], "title": "1.2.1. Secure by Default"}, {"refs": [{"id": "ref-for-http-headerdef-access-control-allow-private-network\u2460"}], "title": "1.2.2. Opting-In"}, {"refs": [{"id": "ref-for-http-headerdef-access-control-allow-private-network\u2461"}], "title": "1.2.3. Navigation"}, {"refs": [{"id": "ref-for-http-headerdef-access-control-allow-private-network\u2462"}], "title": "3.1.2. CORS preflight"}], "external": false};
window.dfnpanelData['treat-as-public-address'] = {"dfnID": "treat-as-public-address", "url": "#treat-as-public-address", "dfnText": "treat-as-public-address", "refSections": [{"refs": [{"id": "ref-for-treat-as-public-address"}], "title": "6. IANA Considerations"}], "external": false};
window.dfnpanelData['connection-ip-address-space'] = {"dfnID": "connection-ip-address-space", "url": "#connection-ip-address-space", "dfnText": "IP address space", "refSections": [{"refs": [{"id": "ref-for-connection-ip-address-space"}, {"id": "ref-for-connection-ip-address-space\u2460"}, {"id": "ref-for-connection-ip-address-space\u2461"}], "title": "3.1.1. Secure context restriction"}, {"refs": [{"id": "ref-for-connection-ip-address-space\u2462"}], "title": "3.1.2. CORS preflight"}], "external": false};
window.dfnpanelData['response-ip-address-space'] = {"dfnID": "response-ip-address-space", "url": "#response-ip-address-space", "dfnText": "IP address space", "refSections": [{"refs": [{"id": "ref-for-response-ip-address-space"}], "title": "3.1.1. Secure context restriction"}, {"refs": [{"id": "ref-for-response-ip-address-space\u2460"}, {"id": "ref-for-response-ip-address-space\u2461"}, {"id": "ref-for-response-ip-address-space\u2462"}, {"id": "ref-for-response-ip-address-space\u2463"}, {"id": "ref-for-response-ip-address-space\u2464"}, {"id": "ref-for-response-ip-address-space\u2465"}, {"id": "ref-for-response-ip-address-space\u2466"}, {"id": "ref-for-response-ip-address-space\u2467"}], "title": "3.1.2. CORS preflight"}, {"refs": [{"id": "ref-for-response-ip-address-space\u2468"}], "title": "3.3. Integration with HTML"}], "external": false};
window.dfnpanelData['private-network-access-check'] = {"dfnID": "private-network-access-check", "url": "#private-network-access-check", "dfnText": "Private Network Access check", "refSections": [{"refs": [{"id": "ref-for-private-network-access-check"}], "title": "3.1.1. Secure context restriction"}, {"refs": [{"id": "ref-for-private-network-access-check\u2460"}], "title": "3.1.2. CORS preflight"}, {"refs": [{"id": "ref-for-private-network-access-check\u2461"}], "title": "3.4. Workers"}, {"refs": [{"id": "ref-for-private-network-access-check\u2462"}], "title": "4.3.2. Subresources"}, {"refs": [{"id": "ref-for-private-network-access-check\u2463"}], "title": "5.6.1. Applying checks to subresources"}], "external": false};
window.dfnpanelData['request-target-ip-address-space'] = {"dfnID": "request-target-ip-address-space", "url": "#request-target-ip-address-space", "dfnText": "target IP address space", "refSections": [{"refs": [{"id": "ref-for-request-target-ip-address-space"}, {"id": "ref-for-request-target-ip-address-space\u2460"}, {"id": "ref-for-request-target-ip-address-space\u2461"}, {"id": "ref-for-request-target-ip-address-space\u2462"}, {"id": "ref-for-request-target-ip-address-space\u2463"}, {"id": "ref-for-request-target-ip-address-space\u2464"}, {"id": "ref-for-request-target-ip-address-space\u2465"}, {"id": "ref-for-request-target-ip-address-space\u2466"}, {"id": "ref-for-request-target-ip-address-space\u2467"}, {"id": "ref-for-request-target-ip-address-space\u2468"}], "title": "3.1.2. CORS preflight"}], "external": false};
window.dfnpanelData['http-no-service-worker-fetch'] = {"dfnID": "http-no-service-worker-fetch", "url": "#http-no-service-worker-fetch", "dfnText": "HTTP-no-service-worker fetch", "refSections": [{"refs": [{"id": "ref-for-http-no-service-worker-fetch"}, {"id": "ref-for-http-no-service-worker-fetch\u2460"}], "title": "3.1.2. CORS preflight"}], "external": false};
window.dfnpanelData['cache-entry-ip-address-space'] = {"dfnID": "cache-entry-ip-address-space", "url": "#cache-entry-ip-address-space", "dfnText": "IP address space", "refSections": [{"refs": [{"id": "ref-for-cache-entry-ip-address-space"}], "title": "3.1.2. CORS preflight"}], "external": false};
window.dfnpanelData['policy-container-ip-address-space'] = {"dfnID": "policy-container-ip-address-space", "url": "#policy-container-ip-address-space", "dfnText": "IP address space", "refSections": [{"refs": [{"id": "ref-for-policy-container-ip-address-space"}], "title": "2.2. Private Network Request"}, {"refs": [{"id": "ref-for-policy-container-ip-address-space\u2460"}], "title": "2.4. The treat-as-public-address Content Security Policy Directive"}, {"refs": [{"id": "ref-for-policy-container-ip-address-space\u2461"}], "title": "3.1.1. Secure context restriction"}, {"refs": [{"id": "ref-for-policy-container-ip-address-space\u2462"}], "title": "3.1.2. CORS preflight"}, {"refs": [{"id": "ref-for-policy-container-ip-address-space\u2463"}, {"id": "ref-for-policy-container-ip-address-space\u2464"}, {"id": "ref-for-policy-container-ip-address-space\u2465"}, {"id": "ref-for-policy-container-ip-address-space\u2466"}, {"id": "ref-for-policy-container-ip-address-space\u2467"}, {"id": "ref-for-policy-container-ip-address-space\u2468"}], "title": "3.3. Integration with HTML"}, {"refs": [{"id": "ref-for-policy-container-ip-address-space\u2460\u24ea"}], "title": "3.4. Workers"}, {"refs": [{"id": "ref-for-policy-container-ip-address-space\u2460\u2460"}], "title": "4.2. Proxies"}, {"refs": [{"id": "ref-for-policy-container-ip-address-space\u2460\u2461"}, {"id": "ref-for-policy-container-ip-address-space\u2460\u2462"}, {"id": "ref-for-policy-container-ip-address-space\u2460\u2463"}], "title": "4.3.1. Main resources"}], "external": false};
</script>
<script>/* Boilerplate: script-dom-helper */
function query(sel) { return document.querySelector(sel); }

function queryAll(sel) { return [...document.querySelectorAll(sel)]; }

function iter(obj) {
	if(!obj) return [];
	var it = obj[Symbol.iterator];
	if(it) return it;
	return Object.entries(obj);
}

function mk(tagname, attrs, ...children) {
	const el = document.createElement(tagname);
	for(const [k,v] of iter(attrs)) {
		if(k.slice(0,3) == "_on") {
			const eventName = k.slice(3);
			el.addEventListener(eventName, v);
		} else if(k[0] == "_") {
			// property, not attribute
			el[k.slice(1)] = v;
		} else {
			if(v === false || v == null) {
        continue;
      } else if(v === true) {
        el.setAttribute(k, "");
        continue;
      } else {
  			el.setAttribute(k, v);
      }
		}
	}
	append(el, children);
	return el;
}

/* Create shortcuts for every known HTML element */
[
  "a",
  "abbr",
  "acronym",
  "address",
  "applet",
  "area",
  "article",
  "aside",
  "audio",
  "b",
  "base",
  "basefont",
  "bdo",
  "big",
  "blockquote",
  "body",
  "br",
  "button",
  "canvas",
  "caption",
  "center",
  "cite",
  "code",
  "col",
  "colgroup",
  "datalist",
  "dd",
  "del",
  "details",
  "dfn",
  "dialog",
  "div",
  "dl",
  "dt",
  "em",
  "embed",
  "fieldset",
  "figcaption",
  "figure",
  "font",
  "footer",
  "form",
  "frame",
  "frameset",
  "head",
  "header",
  "h1",
  "h2",
  "h3",
  "h4",
  "h5",
  "h6",
  "hr",
  "html",
  "i",
  "iframe",
  "img",
  "input",
  "ins",
  "kbd",
  "label",
  "legend",
  "li",
  "link",
  "main",
  "map",
  "mark",
  "meta",
  "meter",
  "nav",
  "nobr",
  "noscript",
  "object",
  "ol",
  "optgroup",
  "option",
  "output",
  "p",
  "param",
  "pre",
  "progress",
  "q",
  "s",
  "samp",
  "script",
  "section",
  "select",
  "small",
  "source",
  "span",
  "strike",
  "strong",
  "style",
  "sub",
  "summary",
  "sup",
  "table",
  "tbody",
  "td",
  "template",
  "textarea",
  "tfoot",
  "th",
  "thead",
  "time",
  "title",
  "tr",
  "u",
  "ul",
  "var",
  "video",
  "wbr",
  "xmp",
].forEach(tagname=>{
	mk[tagname] = (...args) => mk(tagname, ...args);
});

function* nodesFromChildList(children) {
	for(const child of children.flat(Infinity)) {
		if(child instanceof Node) {
			yield child;
		} else {
			yield new Text(child);
		}
	}
}
function append(el, ...children) {
	for(const child of nodesFromChildList(children)) {
		if(el instanceof Node) el.appendChild(child);
		else el.push(child);
	}
	return el;
}

function insertAfter(el, ...children) {
	for(const child of nodesFromChildList(children)) {
		el.parentNode.insertBefore(child, el.nextSibling);
	}
	return el;
}

function clearContents(el) {
	el.innerHTML = "";
	return el;
}

function parseHTML(markup) {
	if(markup.toLowerCase().trim().indexOf('<!doctype') === 0) {
		const doc = document.implementation.createHTMLDocument("");
		doc.documentElement.innerHTML = markup;
		return doc;
	} else {
		const el = mk.template({});
		el.innerHTML = markup;
		return el.content;
	}
}
</script>